name: Deploy Backend via Git

# 触发条件
on:
  # 当推送到主分支且修改后端相关文件时自动触发
  push:
    branches: [ main ]
    paths: 
      - 'backend/**'
      - '.github/workflows/deploy_backend.git.yml'
  # 支持手动触发
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 通过SSH连接服务器进行部署
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.2.0
      with:
        host: ${{ secrets.HOST_PI }}
        username: pi
        password: ${{ secrets.PASS_PI }}
        port: 22
        command_timeout: 10m
        script_stop: true
        envs: USER
        script: |
          # 确保使用正确的用户环境
          export HOME=/home/pi
          export USER=pi
          
          # 加载pi用户的环境配置（包括代理设置）
          source /home/pi/.bashrc || true
          source /home/pi/.profile || true
          
          cd /home/pi/license-manager
          git pull origin main
          pm2 restart license_manager