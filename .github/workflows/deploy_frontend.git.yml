name: Deploy Frontend via Git

# è§¦å‘æ¡ä»¶
on:
  # å½“æ¨é€åˆ°ä¸»åˆ†æ”¯ä¸”ä¿®æ”¹å‰ç«¯ç›¸å…³æ–‡ä»¶æ—¶è‡ªåŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths: 
      - 'frontend/**'
      - '.github/workflows/deploy_frontend.git.yml'
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # æ£€å‡ºä»£ç 
    - name: Checkout repository
      uses: actions/checkout@v4

    # è®¾ç½®Node.jsç¯å¢ƒ
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    # ç¼“å­˜node_moduleså’Œæ„å»ºè¾“å‡º
    - name: Cache dependencies and build
      uses: actions/cache@v4
      with:
        path: |
          frontend/node_modules
          frontend/production
        key: ${{ runner.os }}-frontend-${{ hashFiles('frontend/package-lock.json', 'frontend/src/**/*', 'frontend/vite.config.ts') }}
        restore-keys: |
          ${{ runner.os }}-frontend-${{ hashFiles('frontend/package-lock.json') }}
          ${{ runner.os }}-frontend-

    # å®‰è£…ä¾èµ–
    - name: Install dependencies
      run: |
        cd frontend
        npm ci

    # å¹¶è¡Œæ‰§è¡Œç±»å‹æ£€æŸ¥å’Œæ„å»º
    - name: Type check and build
      run: |
        cd frontend
        # å¹¶è¡Œæ‰§è¡Œç±»å‹æ£€æŸ¥å’Œæ„å»ºä»¥èŠ‚çœæ—¶é—´
        npm run type-check &
        npm run build:prod &
        wait
        # æ£€æŸ¥æ„å»ºç»“æœ
        echo "Build completed, checking production directory:"
        ls -la production/

    # å‡†å¤‡ä¸´æ—¶éƒ¨ç½²ç›®å½•
    - name: Prepare temp directory
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST_PI }}
        username: pi
        password: ${{ secrets.PASS_PI }}
        port: 22
        script: |
          sudo rm -rf /home/pi/lm-www/frontend_tmp
          sudo mkdir -p /home/pi/lm-www/frontend_tmp
          sudo chown -R pi:pi /home/pi/lm-www/frontend_tmp

    # å®‰è£… rsyncï¼ˆç”¨äºå¸¦è¿›åº¦æ˜¾ç¤ºçš„æ–‡ä»¶ä¼ è¾“ï¼‰
    - name: Install rsync
      run: sudo apt-get update && sudo apt-get install -y rsync sshpass

    # è®¡ç®—è¦ä¼ è¾“çš„æ–‡ä»¶æ€»å¤§å°
    - name: Calculate total size
      id: calc_size
      run: |
        cd frontend/production
        TOTAL_SIZE=$(du -sb . | cut -f1)
        echo "total_size=$TOTAL_SIZE" >> $GITHUB_OUTPUT
        echo "Total size to transfer: $(numfmt --to=iec-i --suffix=B $TOTAL_SIZE)"

    # å°†æ„å»ºäº§ç‰©ä¼ è¾“åˆ°æœåŠ¡å™¨ï¼ˆå¸¦è¿›åº¦æ˜¾ç¤ºï¼‰
    - name: Copy build files to server with progress
      run: |
        set -e
        echo "Starting file transfer with rsync..."
        
        # å¯åŠ¨åå°ä¼ è¾“ï¼ˆä½¿ç”¨ --info=progress2 åªæ˜¾ç¤ºæ€»ä½“è¿›åº¦ï¼Œå‡å°‘è¾“å‡ºï¼‰
        sshpass -p "${{ secrets.PASS_PI }}" rsync -avz --info=progress2 \
          -e "ssh -o StrictHostKeyChecking=no" \
          frontend/production/ \
          pi@${{ secrets.HOST_PI }}:/home/pi/lm-www/frontend_tmp/ > /tmp/rsync.log 2>&1 &
        RSYNC_PID=$!
        
        # æ¯10ç§’æ˜¾ç¤ºä¸€æ¬¡è¿›åº¦
        TOTAL_SIZE=${{ steps.calc_size.outputs.total_size }}
        echo "ğŸ“¦ Total size: $(numfmt --to=iec-i --suffix=B $TOTAL_SIZE 2>/dev/null || echo "${TOTAL_SIZE}B")"
        
        while kill -0 $RSYNC_PID 2>/dev/null; do
          sleep 10
          # é€šè¿‡SSHæ£€æŸ¥ç›®æ ‡ç›®å½•å¤§å°
          TRANSFERRED=$(sshpass -p "${{ secrets.PASS_PI }}" ssh -o StrictHostKeyChecking=no \
            pi@${{ secrets.HOST_PI }} \
            "du -sb /home/pi/lm-www/frontend_tmp 2>/dev/null | cut -f1" || echo "0")
          
          if [ "$TRANSFERRED" != "0" ] && [ "$TOTAL_SIZE" != "0" ]; then
            PERCENT=$((TRANSFERRED * 100 / TOTAL_SIZE))
            TRANSFERRED_HR=$(numfmt --to=iec-i --suffix=B $TRANSFERRED 2>/dev/null || echo "${TRANSFERRED}B")
            TOTAL_HR=$(numfmt --to=iec-i --suffix=B $TOTAL_SIZE 2>/dev/null || echo "${TOTAL_SIZE}B")
            echo "ğŸ“¦ Transfer progress: $PERCENT% ($TRANSFERRED_HR / $TOTAL_HR)"
          else
            echo "ğŸ“¦ Transfer in progress..."
          fi
        done
        
        # ç­‰å¾…ä¼ è¾“å®Œæˆå¹¶æ£€æŸ¥é€€å‡ºç 
        wait $RSYNC_PID
        EXIT_CODE=$?
        
        # æ˜¾ç¤º rsync çš„æœ€åå‡ è¡Œè¾“å‡º
        echo "--- rsync output (last 20 lines) ---"
        tail -20 /tmp/rsync.log || true
        
        if [ $EXIT_CODE -eq 0 ]; then
          echo "âœ… File transfer completed!"
        else
          echo "âŒ File transfer failed with exit code $EXIT_CODE"
          exit $EXIT_CODE
        fi
      env:
        DEBIAN_FRONTEND: noninteractive

    # å®Œæˆéƒ¨ç½²ï¼šç›´æ¥æ›¿æ¢å¹¶é‡å¯ nginx
    - name: Deploy to production
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST_PI }}
        username: pi
        password: ${{ secrets.PASS_PI }}
        port: 22
        script: |
          set -e
          
          echo "Deploying to production..."
          sudo rm -rf /home/pi/lm-www/frontend
          sudo mv /home/pi/lm-www/frontend_tmp /home/pi/lm-www/frontend
          
          echo "Setting permissions..."
          sudo chown -R www-data:www-data /home/pi/lm-www/frontend/
          sudo chmod -R 644 /home/pi/lm-www/frontend/
          sudo find /home/pi/lm-www/frontend/ -type d -exec chmod 755 {} \;
          
          echo "Reloading nginx..."
          sudo systemctl reload nginx
          
          echo "âœ… Deployment completed!"