name: Deploy Frontend via Git

# 触发条件
on:
  # 当推送到主分支且修改前端相关文件时自动触发
  push:
    branches: [ main ]
    paths: 
      - 'frontend/**'
      - '.github/workflows/deploy_frontend.git.yml'
  # 支持手动触发
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 检出代码
    - name: Checkout repository
      uses: actions/checkout@v4

    # 设置Node.js环境
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    # 缓存node_modules和构建输出
    - name: Cache dependencies and build
      uses: actions/cache@v4
      with:
        path: |
          frontend/node_modules
          frontend/production
        key: ${{ runner.os }}-frontend-${{ hashFiles('frontend/package-lock.json', 'frontend/src/**/*', 'frontend/vite.config.ts') }}
        restore-keys: |
          ${{ runner.os }}-frontend-${{ hashFiles('frontend/package-lock.json') }}
          ${{ runner.os }}-frontend-

    # 安装依赖
    - name: Install dependencies
      run: |
        cd frontend
        npm ci

    # 并行执行类型检查和构建
    - name: Type check and build
      run: |
        cd frontend
        # 并行执行类型检查和构建以节省时间
        npm run type-check &
        npm run build:prod &
        wait
        # 检查构建结果
        echo "Build completed, checking production directory:"
        ls -la production/

    # 预处理临时部署目录（不影响当前服务）
    - name: Prepare temp deployment directory
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST_PI }}
        username: pi
        password: ${{ secrets.PASS_PI }}
        port: 22
        script: |
          set -e
          echo "Preparing temp deployment directory..."
          
          sudo rm -rf /home/pi/lm-www/frontend_tmp
          sudo mkdir -p /home/pi/lm-www/frontend_tmp
          
          # 设置正确的目录权限供文件传输
          sudo chown -R pi:pi /home/pi/lm-www/frontend_tmp
          sudo chmod -R 755 /home/pi/lm-www/frontend_tmp

    # 将构建产物传输到服务器
    - name: Copy build files to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HOST_PI }}
        username: pi
        password: ${{ secrets.PASS_PI }}
        port: 22
        source: "frontend/production/*"
        target: "/home/pi/lm-www/frontend_tmp/"
        overwrite: true

    # 完成部署配置
    - name: Finalize deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST_PI }}
        username: pi
        password: ${{ secrets.PASS_PI }}
        port: 22
        script: |
          echo "Finalizing deployment..."
          
          set -e
          
          if [ ! -d /home/pi/lm-www/frontend_tmp ]; then
            echo "❌ Temp directory not found, aborting."
            exit 1
          fi
          
          echo "Stopping nginx..."
          sudo systemctl stop nginx || true
          
          echo "Switching deployment directories..."
          sudo rm -rf /home/pi/lm-www/frontend_prev
          if [ -d /home/pi/lm-www/frontend ]; then
            sudo mv /home/pi/lm-www/frontend /home/pi/lm-www/frontend_prev
          fi
          sudo mv /home/pi/lm-www/frontend_tmp /home/pi/lm-www/frontend
          
          echo "Setting web server permissions..."
          sudo chown -R www-data:www-data /home/pi/lm-www/frontend/
          sudo chmod -R 644 /home/pi/lm-www/frontend/
          sudo find /home/pi/lm-www/frontend/ -type d -exec chmod 755 {} \;
          
          echo "Starting nginx..."
          if sudo nginx -t; then
            sudo systemctl start nginx
            sudo systemctl reload nginx
            
            if sudo systemctl is-active --quiet nginx; then
              echo "✅ Frontend deployment completed successfully!"
              sudo rm -rf /home/pi/lm-www/frontend_prev
            else
              echo "❌ Nginx failed to start, attempting rollback..."
              if [ -d /home/pi/lm-www/frontend_prev ]; then
                sudo rm -rf /home/pi/lm-www/frontend
                sudo mv /home/pi/lm-www/frontend_prev /home/pi/lm-www/frontend
              fi
              sudo systemctl start nginx || true
              sudo systemctl reload nginx || true
              sudo systemctl status nginx --no-pager -l
              exit 1
            fi
          else
            echo "❌ Nginx configuration test failed! Rolling back..."
            if [ -d /home/pi/lm-www/frontend_prev ]; then
              sudo rm -rf /home/pi/lm-www/frontend
              sudo mv /home/pi/lm-www/frontend_prev /home/pi/lm-www/frontend
            fi
            exit 1
          fi