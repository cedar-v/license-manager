name: Deploy Frontend via Git

# è§¦å‘æ¡ä»¶
on:
  # å½“æ¨é€åˆ°ä¸»åˆ†æ”¯ä¸”ä¿®æ”¹å‰ç«¯ç›¸å…³æ–‡ä»¶æ—¶è‡ªåŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths: 
      - 'frontend/**'
      - '.github/workflows/deploy_frontend.git.yml'
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # æ£€å‡ºä»£ç 
    - name: Checkout repository
      uses: actions/checkout@v4

    # è®¾ç½®Node.jsç¯å¢ƒ
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    # ç¼“å­˜node_modulesï¼ˆä¸ç¼“å­˜æ„å»ºè¾“å‡ºï¼Œç¡®ä¿æ¯æ¬¡éƒ½æ˜¯æœ€æ–°æ„å»ºï¼‰
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          frontend/node_modules
        key: ${{ runner.os }}-frontend-deps-${{ hashFiles('frontend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-frontend-deps-

    # å®‰è£…ä¾èµ–
    - name: Install dependencies
      run: |
        cd frontend
        npm ci

    # æ¸…ç†æ—§çš„æ„å»ºç›®å½•ï¼ˆç¡®ä¿ä½¿ç”¨æœ€æ–°ä»£ç æ„å»ºï¼‰
    - name: Clean old build artifacts
      run: |
        cd frontend
        rm -rf production dist
        echo "Cleaned old build directories"

    # æ‰§è¡Œç±»å‹æ£€æŸ¥å’Œæ„å»º
    - name: Type check and build
      run: |
        cd frontend
        # è®¾ç½®æ„å»ºç¯å¢ƒå˜é‡ï¼Œç¡®ä¿ä¸æœ¬åœ°æ„å»ºä¸€è‡´
        export VITE_OUTDIR=production
        export VITE_ADDRESS_BASE_URL=/production/
        # å…ˆæ‰§è¡Œç±»å‹æ£€æŸ¥
        npm run type-check
        # ç„¶åæ‰§è¡Œæ„å»º
        npm run build:prod
        # æ£€æŸ¥æ„å»ºç»“æœ
        echo "Build completed, checking production directory:"
        ls -la production/
        # éªŒè¯æ„å»ºäº§ç‰©ä¸­çš„ base è·¯å¾„
        echo "Verifying base path in index.html:"
        grep -o 'href="/production/' production/index.html | head -1 || echo "Warning: base path not found"
        # æ˜¾ç¤ºæ„å»ºäº§ç‰©çš„æ—¶é—´æˆ³ï¼Œç¡®è®¤æ˜¯æ–°æ„å»ºçš„
        echo "Build timestamp:"
        stat production/index.html 2>/dev/null || ls -la production/index.html

    # å‡†å¤‡ä¸´æ—¶éƒ¨ç½²ç›®å½•
    - name: Prepare temp directory
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST43 }}
        username: root
        password: ${{ secrets.PASS43 }}
        port: 22
        script: |
          sudo rm -rf /home/pi/lm-www/frontend_tmp
          sudo mkdir -p /home/pi/lm-www/frontend_tmp/production
          sudo chown -R root:root /home/pi/lm-www/frontend_tmp

    # å®‰è£… rsyncï¼ˆç”¨äºå¸¦è¿›åº¦æ˜¾ç¤ºçš„æ–‡ä»¶ä¼ è¾“ï¼‰
    - name: Install rsync
      run: sudo apt-get update && sudo apt-get install -y rsync sshpass

    # è®¡ç®—è¦ä¼ è¾“çš„æ–‡ä»¶æ€»å¤§å°
    - name: Calculate total size
      id: calc_size
      run: |
        cd frontend/production
        TOTAL_SIZE=$(du -sb . | cut -f1)
        echo "total_size=$TOTAL_SIZE" >> $GITHUB_OUTPUT
        echo "Total size to transfer: $(numfmt --to=iec-i --suffix=B $TOTAL_SIZE)"

    # å°†æ„å»ºäº§ç‰©ä¼ è¾“åˆ°æœåŠ¡å™¨ï¼ˆå¸¦è¿›åº¦æ˜¾ç¤ºï¼‰
    - name: Copy build files to server with progress
      run: |
        set -e
        echo "Starting file transfer with rsync..."
        
        # å¯åŠ¨åå°ä¼ è¾“ï¼ˆä½¿ç”¨ --info=progress2 åªæ˜¾ç¤ºæ€»ä½“è¿›åº¦ï¼Œå‡å°‘è¾“å‡ºï¼‰
        sshpass -p "${{ secrets.PASS43 }}" rsync -avz --info=progress2 \
          -e "ssh -o StrictHostKeyChecking=no" \
          frontend/production/ \
          pi@${{ secrets.HOST43 }}:/home/pi/lm-www/frontend_tmp/production/ > /tmp/rsync.log 2>&1 &
        RSYNC_PID=$!
        
        # æ¯10ç§’æ˜¾ç¤ºä¸€æ¬¡è¿›åº¦
        TOTAL_SIZE=${{ steps.calc_size.outputs.total_size }}
        echo "ğŸ“¦ Total size: $(numfmt --to=iec-i --suffix=B $TOTAL_SIZE 2>/dev/null || echo "${TOTAL_SIZE}B")"
        
        while kill -0 $RSYNC_PID 2>/dev/null; do
          sleep 10
            # é€šè¿‡SSHæ£€æŸ¥ç›®æ ‡ç›®å½•å¤§å°
            TRANSFERRED=$(sshpass -p "${{ secrets.PASS43 }}" ssh -o StrictHostKeyChecking=no \
              pi@${{ secrets.HOST43 }} \
              "du -sb /home/pi/lm-www/frontend_tmp/production 2>/dev/null | cut -f1" || echo "0")
          
          if [ "$TRANSFERRED" != "0" ] && [ "$TOTAL_SIZE" != "0" ]; then
            PERCENT=$((TRANSFERRED * 100 / TOTAL_SIZE))
            TRANSFERRED_HR=$(numfmt --to=iec-i --suffix=B $TRANSFERRED 2>/dev/null || echo "${TRANSFERRED}B")
            TOTAL_HR=$(numfmt --to=iec-i --suffix=B $TOTAL_SIZE 2>/dev/null || echo "${TOTAL_SIZE}B")
            echo "ğŸ“¦ Transfer progress: $PERCENT% ($TRANSFERRED_HR / $TOTAL_HR)"
          else
            echo "ğŸ“¦ Transfer in progress..."
          fi
        done
        
        # ç­‰å¾…ä¼ è¾“å®Œæˆå¹¶æ£€æŸ¥é€€å‡ºç 
        wait $RSYNC_PID
        EXIT_CODE=$?
        
        # æ˜¾ç¤º rsync çš„æœ€åå‡ è¡Œè¾“å‡º
        echo "--- rsync output (last 20 lines) ---"
        tail -20 /tmp/rsync.log || true
        
        if [ $EXIT_CODE -eq 0 ]; then
          echo "âœ… File transfer completed!"
        else
          echo "âŒ File transfer failed with exit code $EXIT_CODE"
          exit $EXIT_CODE
        fi
      env:
        DEBIAN_FRONTEND: noninteractive

    # å®Œæˆéƒ¨ç½²ï¼šç›´æ¥æ›¿æ¢å¹¶é‡å¯ nginx
    - name: Deploy to production
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST43 }}
        username: pi
        password: ${{ secrets.PASS43 }}
        port: 22
        script: |
          set -e
          
          echo "Deploying to production..."
          # ç¡®ä¿ frontend ç›®å½•å­˜åœ¨
          sudo mkdir -p /home/pi/lm-www/frontend
          # åˆ é™¤åŸæœ‰çš„ production ç›®å½•
          sudo rm -rf /home/pi/lm-www/frontend/production
          # å°†æ–°çš„ production ç›®å½•ç§»è¿‡å»
          sudo mv /home/pi/lm-www/frontend_tmp/production /home/pi/lm-www/frontend/production
          # æ¸…ç†ä¸´æ—¶ç›®å½•
          sudo rm -rf /home/pi/lm-www/frontend_tmp
          
          echo "Setting permissions..."
          sudo chown -R www-data:www-data /home/pi/lm-www/frontend/
          sudo chmod -R 644 /home/pi/lm-www/frontend/
          sudo find /home/pi/lm-www/frontend/ -type d -exec chmod 755 {} \;
          
          echo "Verifying deployment structure..."
          ls -la /home/pi/lm-www/frontend/
          ls -la /home/pi/lm-www/frontend/production/ || echo "Warning: production directory not found"
          
          echo "Reloading nginx..."
          sudo systemctl reload nginx
          
          echo "âœ… Deployment completed!"