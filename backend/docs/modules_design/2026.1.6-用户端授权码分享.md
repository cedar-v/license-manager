# ç”¨æˆ·ç«¯æˆæƒç åˆ†äº«

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ç”¨æˆ·å¯ä»¥å°†è‡ªå·±çš„æˆæƒç åˆ†äº«ç»™å…¶ä»–ç”¨æˆ·ï¼Œå—èµ ç”¨æˆ·å¯ä»¥æ¿€æ´»ä½¿ç”¨è¯¥æˆæƒç ã€‚

## ğŸ¯ æ ¸å¿ƒéœ€æ±‚

- **åˆ†äº«æ“ä½œ**ï¼šAç”¨æˆ·å¯ä»¥å°†å…¶æˆæƒç çš„éƒ¨åˆ†æ¿€æ´»æ¬¡æ•°åˆ†äº«ç»™Bç”¨æˆ·
- **æ–°ç ç”Ÿæˆ**ï¼šç³»ç»Ÿä¸ºBç”¨æˆ·ç”Ÿæˆæ–°çš„æˆæƒç ï¼Œæ—¶é—´èŒƒå›´ä»åˆ†äº«æ—¶åˆ»åˆ°åŸæˆæƒç ç»“æŸæ—¶é—´
- **äº‹åŠ¡ä¿è¯**ï¼šæ•´ä¸ªåˆ†äº«è¿‡ç¨‹å¿…é¡»æ”¯æŒæ•°æ®åº“äº‹åŠ¡ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§

## ğŸ”„ ä¸šåŠ¡æµç¨‹

### åˆ†äº«æ“ä½œæµç¨‹ï¼š
1. Aç”¨æˆ·åœ¨åå°é€‰æ‹©è¦åˆ†äº«çš„æˆæƒç 
2. è¾“å…¥Bç”¨æˆ·çš„ç”¨æˆ·ID
3. é€‰æ‹©åˆ†äº«æ•°é‡ï¼ˆæœ€å¤§åˆ†äº«æ•°é‡ = æˆæƒç æœ€å¤§æ¿€æ´»æ•° - å·²æ¿€æ´»æ•°ï¼‰
4. ç¡®è®¤åˆ†äº«æ“ä½œ

### ç³»ç»Ÿå¤„ç†é€»è¾‘ï¼š
1. **å‚æ•°æ ¡éªŒ**ï¼šéªŒè¯åˆ†äº«æ•°é‡ä¸è¶…è¿‡å¯ç”¨æ¿€æ´»æ•°ï¼ŒéªŒè¯ç›®æ ‡ç”¨æˆ·å­˜åœ¨
2. **æ‰£å‡æ“ä½œ**ï¼šAç”¨æˆ·çš„æˆæƒç  `max_activations` å‡å°‘ç›¸åº”æ•°é‡
3. **ç”Ÿæˆæ–°ç **ï¼šä¸ºBç”¨æˆ·é‡æ–°ç”Ÿæˆæˆæƒç 
   - æ—¶é—´èŒƒå›´ï¼šä»å½“å‰æ—¶é—´åˆ°åŸæˆæƒç ç»“æŸæ—¶é—´
   - æ¿€æ´»æ•°é‡ï¼šåˆ†äº«çš„æ•°é‡
   - å…¶ä»–å‚æ•°ï¼šä¸åŸæˆæƒç å®Œå…¨ç›¸åŒ
4. **äº‹åŠ¡ä¿è¯**ï¼šæ•´ä¸ªè¿‡ç¨‹åœ¨æ•°æ®åº“äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œå¤±è´¥æ—¶å®Œå…¨å›æ»š

## ğŸ› ï¸ APIæ¥å£è®¾è®¡

### åˆ†äº«æˆæƒç 

**æ¥å£**: `POST /api/v1/user/authorization-codes/{codeId}/share`

**è¯·æ±‚å‚æ•°**:
```json
{
  "target_user_id": "string",  // å—èµ ç”¨æˆ·ID
  "share_count": 5             // åˆ†äº«æ¿€æ´»æ¬¡æ•°
}
```

**å“åº”æ ¼å¼**:
```json
{
  "code": "000000",
  "message": "åˆ†äº«æˆåŠŸ",
  "data": {
    "new_authorization_code": {
      "id": "string",
      "code": "string",
      "start_date": "2024-01-01T00:00:00Z",
      "end_date": "2024-12-31T23:59:59Z",
      "max_activations": 5
    }
  }
}
```

## âš ï¸ é”™è¯¯å¤„ç†

| é”™è¯¯ç  | é”™è¯¯åœºæ™¯ | HTTPçŠ¶æ€ç  |
|--------|----------|------------|
| 300101 | æˆæƒç ä¸å­˜åœ¨ | 404 |
| 300102 | æˆæƒç å·²è¢«é”å®š | 403 |
| 300103 | åˆ†äº«æ•°é‡è¶…è¿‡å¯ç”¨æ¿€æ´»æ•° | 400 |
| 300104 | ç›®æ ‡ç”¨æˆ·ä¸å­˜åœ¨ | 404 |
| 300105 | ä¸èƒ½åˆ†äº«ç»™è‡ªå·± | 400 |
| 300106 | æ•°æ®åº“äº‹åŠ¡å¤±è´¥ | 500 |

## ğŸ”’ å®‰å…¨è€ƒè™‘

- **æƒé™éªŒè¯**ï¼šç”¨æˆ·åªèƒ½åˆ†äº«è‡ªå·±æ‹¥æœ‰çš„æˆæƒç 
- **å‚æ•°æ ¡éªŒ**ï¼šåˆ†äº«æ•°é‡å¿…é¡»ä¸ºæ­£æ•´æ•°ï¼Œä¸èƒ½è¶…è¿‡å¯ç”¨æ¿€æ´»æ•°
- **ç”¨æˆ·éªŒè¯**ï¼šç›®æ ‡ç”¨æˆ·å¿…é¡»å­˜åœ¨ä¸”çŠ¶æ€æ­£å¸¸
- **é˜²æ­¢è‡ªèµ **ï¼šä¸èƒ½åˆ†äº«ç»™è‡ªå·±

## ğŸ—ï¸ å®ç°è¦ç‚¹

### æŠ€æœ¯æ¶æ„è¦æ±‚ï¼š
- **åˆ†å±‚æ¶æ„**ï¼šHandler â†’ Service â†’ Repository
- **äº‹åŠ¡æ”¯æŒ**ï¼šå¿…é¡»ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§
- **å¤šè¯­è¨€æ”¯æŒ**ï¼šé”™è¯¯ä¿¡æ¯æ”¯æŒå›½é™…åŒ–
- **æ—¥å¿—è®°å½•**ï¼šè®°å½•æ‰€æœ‰åˆ†äº«æ“ä½œçš„è¯¦ç»†æ—¥å¿—

### æ•°æ®åº“äº‹åŠ¡ï¼š
```sql
BEGIN TRANSACTION;
-- 1. å‡å°‘åŸæˆæƒç çš„max_activations
UPDATE authorization_codes SET max_activations = max_activations - ? WHERE id = ?;
-- 2. ä¸ºç›®æ ‡ç”¨æˆ·åˆ›å»ºæ–°çš„æˆæƒç 
INSERT INTO authorization_codes (...) VALUES (...);
COMMIT;
```

## ğŸ“Š æ•°æ®è¡¨ç»“æ„

### authorization_codes - æˆæƒç è¡¨
```sql
CREATE TABLE `authorization_codes` (
  `id` varchar(36) NOT NULL,
  `code` varchar(1000) NOT NULL,           -- åŠ å¯†åçš„æˆæƒç 
  `customer_id` varchar(36) NOT NULL,       -- å®¢æˆ·ID
  `created_by` varchar(36) NOT NULL,        -- åˆ›å»ºè€…ç”¨æˆ·ID
  `software_id` varchar(50) DEFAULT NULL,   -- è½¯ä»¶ID
  `description` text,                       -- æè¿°
  `start_date` datetime(3) NOT NULL,        -- å¼€å§‹æ—¶é—´
  `end_date` datetime(3) NOT NULL,          -- ç»“æŸæ—¶é—´
  `deployment_type` varchar(20) NOT NULL DEFAULT 'standalone', -- éƒ¨ç½²ç±»å‹
  `encryption_type` varchar(20) DEFAULT 'standard', -- åŠ å¯†ç±»å‹
  `software_version` varchar(50) DEFAULT NULL, -- è½¯ä»¶ç‰ˆæœ¬
  `max_activations` bigint NOT NULL DEFAULT '1', -- æœ€å¤§æ¿€æ´»æ¬¡æ•°
  `is_locked` tinyint(1) NOT NULL DEFAULT '0', -- æ˜¯å¦é”å®š
  `lock_reason` text,                       -- é”å®šåŸå› 
  `locked_at` datetime(3) DEFAULT NULL,     -- é”å®šæ—¶é—´
  `locked_by` varchar(36) DEFAULT NULL,     -- é”å®šè€…
  `feature_config` json DEFAULT NULL,       -- åŠŸèƒ½é…ç½®
  `usage_limits` json DEFAULT NULL,         -- ä½¿ç”¨é™åˆ¶
  `custom_parameters` json DEFAULT NULL,    -- è‡ªå®šä¹‰å‚æ•°
  `created_at` datetime(3) NOT NULL,
  `updated_at` datetime(3) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_authorization_codes_customer_id` (`customer_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
```

### licenses - è®¸å¯è¯è¡¨
```sql
CREATE TABLE `licenses` (
  `id` varchar(36) NOT NULL,
  `license_key` varchar(200) NOT NULL,      -- è®¸å¯è¯å¯†é’¥
  `authorization_code_id` varchar(36) NOT NULL, -- æˆæƒç ID
  `customer_id` varchar(36) NOT NULL,       -- å®¢æˆ·ID
  `hardware_fingerprint` varchar(200) NOT NULL, -- ç¡¬ä»¶æŒ‡çº¹
  `device_info` json DEFAULT NULL,          -- è®¾å¤‡ä¿¡æ¯
  `activation_ip` varchar(45) DEFAULT NULL, -- æ¿€æ´»IP
  `status` varchar(20) NOT NULL DEFAULT 'inactive', -- çŠ¶æ€
  `activated_at` datetime(3) DEFAULT NULL,  -- æ¿€æ´»æ—¶é—´
  `last_heartbeat` datetime(3) DEFAULT NULL,-- æœ€åå¿ƒè·³
  `last_online_ip` varchar(45) DEFAULT NULL, -- æœ€ååœ¨çº¿IP
  `config_updated_at` datetime(3) DEFAULT NULL, -- é…ç½®æ›´æ–°æ—¶é—´
  `usage_data` json DEFAULT NULL,           -- ä½¿ç”¨æ•°æ®
  `created_at` datetime(3) NOT NULL,
  `updated_at` datetime(3) NOT NULL,
  `deleted_at` datetime(3) DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_licenses_license_key` (`license_key`),
  KEY `idx_licenses_authorization_code_id` (`authorization_code_id`),
  KEY `idx_licenses_customer_id` (`customer_id`),
  KEY `idx_licenses_hardware_fingerprint` (`hardware_fingerprint`),
  KEY `idx_licenses_status` (`status`),
  KEY `idx_licenses_activated_at` (`activated_at`),
  KEY `idx_licenses_last_heartbeat` (`last_heartbeat`),
  KEY `idx_licenses_config_updated_at` (`config_updated_at`),
  KEY `idx_licenses_created_at` (`created_at`),
  KEY `idx_licenses_deleted_at` (`deleted_at`),
  CONSTRAINT `fk_licenses_authorization_code` FOREIGN KEY (`authorization_code_id`) REFERENCES `authorization_codes` (`id`) ON DELETE CASCADE ON UPDATE RESTRICT,
  CONSTRAINT `fk_licenses_customer` FOREIGN KEY (`customer_id`) REFERENCES `customers` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
```

### cu_users - å®¢æˆ·ç”¨æˆ·è¡¨
```sql
CREATE TABLE `cu_users` (
  `id` varchar(36) NOT NULL,
  `customer_id` varchar(36) NOT NULL,       -- å®¢æˆ·ID
  `phone` varchar(20) NOT NULL,             -- æ‰‹æœºå·
  `phone_country_code` varchar(10) NOT NULL DEFAULT '+86', -- å›½å®¶ä»£ç 
  `password` varchar(255) DEFAULT NULL,     -- å¯†ç 
  `salt` varchar(32) DEFAULT NULL,          -- å¯†ç ç›
  `user_role` varchar(20) NOT NULL DEFAULT 'member', -- ç”¨æˆ·è§’è‰²
  `real_name` varchar(100) DEFAULT NULL,    -- çœŸå®å§“å
  `email` varchar(255) DEFAULT NULL,        -- é‚®ç®±
  `status` varchar(20) NOT NULL DEFAULT 'active', -- çŠ¶æ€
  `phone_verified` tinyint(1) NOT NULL DEFAULT '1', -- æ‰‹æœºå·éªŒè¯
  `email_verified` tinyint(1) NOT NULL DEFAULT '0', -- é‚®ç®±éªŒè¯
  `last_login_at` datetime(3) DEFAULT NULL, -- æœ€åç™»å½•æ—¶é—´
  `last_login_ip` varchar(50) DEFAULT NULL, -- æœ€åç™»å½•IP
  `login_attempts` bigint NOT NULL DEFAULT '0', -- ç™»å½•å°è¯•æ¬¡æ•°
  `locked_until` datetime(3) DEFAULT NULL,   -- é”å®šåˆ°æœŸæ—¶é—´
  `avatar_url` varchar(500) DEFAULT NULL,   -- å¤´åƒURL
  `language` varchar(10) NOT NULL DEFAULT 'zh-CN', -- è¯­è¨€
  `timezone` varchar(50) NOT NULL DEFAULT 'Asia/Shanghai', -- æ—¶åŒº
  `additional_info` json DEFAULT NULL,      -- é™„åŠ ä¿¡æ¯
  `remark` text,                            -- å¤‡æ³¨
  `created_at` datetime(3) NOT NULL,
  `updated_at` datetime(3) NOT NULL,
  `deleted_at` datetime(3) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_cu_users_customer_id` (`customer_id`),
  KEY `idx_cu_users_email` (`email`),
  KEY `idx_cu_users_status` (`status`),
  KEY `idx_cu_users_last_login_at` (`last_login_at`),
  KEY `idx_cu_users_locked_until` (`locked_until`),
  KEY `idx_cu_users_created_at` (`created_at`),
  KEY `idx_cu_users_deleted_at` (`deleted_at`),
  KEY `idx_cu_users_phone` (`phone`,`phone_country_code`),
  KEY `idx_cu_users_customer_status` (`customer_id`,`status`),
  KEY `idx_cu_users_status_locked` (`status`,`locked_until`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
```

## ğŸ“‹ å¼€å‘è§„èŒƒ

### éµå¾ªåŸåˆ™ï¼š
- **åˆ†å±‚æ¶æ„**ï¼šHandler â†’ Service â†’ Repository
- **ä¾èµ–æ³¨å…¥**ï¼šé€šè¿‡æ¥å£è§£è€¦å„å±‚ä¾èµ–
- **å¤šè¯­è¨€æ”¯æŒ**ï¼šé”™è¯¯ä¿¡æ¯æ”¯æŒå›½é™…åŒ–
- **ç»Ÿä¸€å“åº”**ï¼šéµå¾ªé¡¹ç›®APIå“åº”æ ¼å¼è§„èŒƒ

### ä»£ç ç»“æ„ï¼š
```
internal/
â”œâ”€â”€ api/handlers/
â”‚   â””â”€â”€ user_authorization_handler.go    # ç”¨æˆ·æˆæƒå¤„ç†å™¨
â”œâ”€â”€ service/
â”‚   â””â”€â”€ user_authorization_service.go    # ç”¨æˆ·æˆæƒä¸šåŠ¡é€»è¾‘
â””â”€â”€ repository/
    â””â”€â”€ user_authorization_repository.go  # ç”¨æˆ·æˆæƒæ•°æ®è®¿é—®
```

### è´¨é‡æ£€æŸ¥ï¼š
- [ ] åˆ†å±‚èŒè´£æ˜¯å¦æ¸…æ™°
- [ ] å¤šè¯­è¨€å­—æ®µæ˜¯å¦å®Œæ•´
- [ ] é”™è¯¯å¤„ç†æ˜¯å¦ç»Ÿä¸€
- [ ] äº‹åŠ¡è¾¹ç•Œæ˜¯å¦æ­£ç¡®
- [ ] å‚æ•°æ ¡éªŒæ˜¯å¦å®Œæ•´
- [ ] æ—¥å¿—è®°å½•æ˜¯å¦å®Œå–„