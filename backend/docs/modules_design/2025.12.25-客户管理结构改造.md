# 客户管理结构改造 - 客户用户管理模块

## 需求概述

为支持客户自主注册和使用客户端，需要构建独立的客户用户管理体系。

**核心要求：**
- 只支持手机号注册，通过短信验证码验证
- 用户体系完全独立，与原有系统管理员用户体系分离
- 鉴权和路由模块与原有系统完全分开，实现安全隔离和独立演进

## 原customers表结构

-- license_manager.customers definition

CREATE TABLE `customers` (
  `id` varchar(36) NOT NULL DEFAULT (uuid()),
  `customer_code` varchar(20) NOT NULL,
  `customer_name` varchar(200) NOT NULL,
  `customer_type` varchar(20) NOT NULL DEFAULT 'enterprise',
  `contact_person` varchar(100) NOT NULL,
  `contact_title` varchar(100) DEFAULT NULL,
  `email` varchar(255) DEFAULT NULL,
  `phone` varchar(20) DEFAULT NULL,
  `address` text,
  `company_size` varchar(20) DEFAULT NULL,
  `customer_level` varchar(20) NOT NULL DEFAULT 'basic',
  `status` varchar(20) NOT NULL DEFAULT 'active',
  `description` text,
  `created_at` datetime(3) NOT NULL,
  `updated_at` datetime(3) NOT NULL,
  `created_by` varchar(36) NOT NULL,
  `updated_by` varchar(36) DEFAULT NULL,
  `deleted_at` datetime(3) DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_customers_customer_code` (`customer_code`),
  KEY `idx_customers_customer_name` (`customer_name`),
  KEY `idx_customers_customer_type` (`customer_type`),
  KEY `idx_customers_customer_level` (`customer_level`),
  KEY `idx_customers_status` (`status`),
  KEY `idx_customers_created_at` (`created_at`),
  KEY `idx_customers_created_by` (`created_by`),
  KEY `idx_customers_deleted_at` (`deleted_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

## 需求背景

当与客户签约后，原授权管理平台的客户是系统管理员通过后管手动添加的。现要支持客户自动注册，给客户专门开发了一个客户端，客户可以自己注册账号并登录使用。

**核心变更：**
- 用户体系完全独立：客户用户与系统管理员用户完全分离
- 注册方式：仅支持手机号注册，通过短信验证码验证
- 安全隔离：鉴权和路由模块与原有系统完全分开，独立演进

## 新增表结构

-- mysql客户用户表（新增）
CREATE TABLE `cu_users` (
  `id` VARCHAR(36) NOT NULL DEFAULT (uuid()),
  `customer_id` VARCHAR(36) NOT NULL COMMENT '所属客户ID',
  `phone` VARCHAR(20) NOT NULL COMMENT '手机号（作为登录账号）',
  `phone_country_code` VARCHAR(10) DEFAULT '+86' COMMENT '国家代码',
  `password` VARCHAR(255) NULL COMMENT '密码（可选，用于增强安全）',
  `salt` VARCHAR(32) NULL COMMENT '密码盐值',
  `user_role` VARCHAR(20) NOT NULL DEFAULT 'member' COMMENT '角色: admin-企业管理员, member-普通成员',
  `real_name` VARCHAR(100) NULL COMMENT '真实姓名',
  `email` VARCHAR(255) NULL COMMENT '邮箱（可选）',
  `status` VARCHAR(20) NOT NULL DEFAULT 'active' COMMENT '状态: active-正常, disabled-禁用, pending-待激活',
  `phone_verified` TINYINT(1) DEFAULT 1 COMMENT '手机是否验证（注册时已验证）',
  `email_verified` TINYINT(1) DEFAULT 0 COMMENT '邮箱是否验证',
  `last_login_at` DATETIME(3) DEFAULT NULL COMMENT '最后登录时间',
  `last_login_ip` VARCHAR(50) DEFAULT NULL COMMENT '最后登录IP',
  `login_fail_count` INT DEFAULT 0 COMMENT '登录失败次数',
  `locked_until` DATETIME(3) DEFAULT NULL COMMENT '锁定截止时间',
  `created_at` DATETIME(3) NOT NULL,
  `updated_at` DATETIME(3) NOT NULL,
  `updated_by` VARCHAR(36) DEFAULT NULL,
  `deleted_at` DATETIME(3) DEFAULT NULL,
  -- ========== 用户偏好设置 ==========
  `avatar_url` VARCHAR(500) DEFAULT NULL COMMENT '头像URL',
  `language` VARCHAR(10) DEFAULT 'zh-CN',
  `timezone` VARCHAR(50) DEFAULT 'Asia/Shanghai',
  `additional_info` JSON DEFAULT NULL COMMENT '附加信息',
  `remark` TEXT DEFAULT NULL COMMENT '备注',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_cu_users_phone` (`phone`, `phone_country_code`),
  UNIQUE KEY `idx_cu_users_email` (`email`),
  KEY `idx_cu_users_customer_id` (`customer_id`),
  KEY `idx_cu_users_status` (`status`),
  KEY `idx_cu_users_created_at` (`created_at`),
  KEY `idx_cu_users_deleted_at` (`deleted_at`),
  CONSTRAINT `fk_cu_users_customer_id` FOREIGN KEY (`customer_id`) REFERENCES `customers` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

## 字段说明

### 核心身份字段
- `customer_id`: 关联客户ID，建立用户与客户的关系
- `phone`: 手机号，作为主要登录账号（手机号+国家代码唯一）
- `phone_country_code`: 国家代码，默认+86

### 安全字段
- `password`: 密码（可选，用于增强安全）
- `salt`: 密码盐值
- `user_role`: 用户角色
  - `admin`: 企业管理员（可管理企业成员）
  - `member`: 普通成员

### 基础信息字段
- `real_name`: 用户真实姓名
- `email`: 邮箱地址（可选，全局唯一）

### 状态管理字段
- `status`: 用户状态
  - `active`: 正常状态
  - `disabled`: 禁用状态
  - `pending`: 待激活状态
- `phone_verified`: 手机验证状态（注册时已验证）
- `email_verified`: 邮箱验证状态

### 安全监控字段
- `last_login_at`: 最后登录时间
- `last_login_ip`: 最后登录IP
- `login_fail_count`: 登录失败次数
- `locked_until`: 账户锁定截止时间

### 偏好设置字段
- `avatar_url`: 用户头像URL
- `language`: 界面语言，默认zh-CN
- `timezone`: 时区设置，默认Asia/Shanghai
- `additional_info`: 附加信息，JSON格式存储
- `remark`: 备注信息

## 核心功能

### 手机号注册
- 仅支持手机号注册方式
- 通过短信验证码验证手机号真实性
- 手机号+国家代码全局唯一
- 注册成功后自动创建用户记录

### 短信验证码机制
- 发送短信验证码API
- 验证码存储在Redis中，有效期控制（通常5分钟）
- 验证码使用后立即删除，防止重复使用
- 验证码错误次数限制
- 防短信轰炸机制（频率限制）

### 用户登录
- 手机号+密码登录（主要方式）
- 手机号+短信验证码登录（备用方式）
- 登录失败次数限制和账户锁定
- 登录历史记录和IP追踪

### 用户信息管理
- 用户信息查看和编辑
- 邮箱绑定和验证（可选）
- 密码设置和管理
- 用户偏好设置
- 手机号修改（验证新旧手机号）
- 角色权限管理（管理员功能）

### 密码管理
- 忘记密码流程（短信验证码重置）
- 修改密码（验证当前密码）
- 密码强度要求和安全策略

### 安全特性
- 手机号实名验证
- 短信验证码二次验证
- 登录失败自动锁定
- 敏感操作日志记录
- IP访问记录追踪

## 认证和路由隔离设计

**采用共享架构，分组隔离的设计方案**

### 为什么需要隔离？
1. **用户体系不同**：SAAS用户是客户员工，原有用户是系统管理员
2. **安全隔离要求**：防止SAAS用户访问系统管理功能
3. **独立演进**：允许SAAS用户系统独立升级和维护

### 共享架构优势
- 避免代码重复，保持架构一致性
- 通过路由组实现逻辑隔离
- 共享核心组件，降低维护成本
- 符合现有Clean Architecture设计原则

### 认证隔离策略
#### 双认证体系
- **管理员认证**：原有JWT认证体系，针对系统管理员
- **客户认证**：新增的客户用户认证体系，针对客户用户

#### 认证中间件扩展

```go
// internal/api/middleware/auth.go

// AdminAuth 原有管理员认证中间件
func AdminAuth() gin.HandlerFunc {
    // 使用管理员JWT密钥验证
    // 检查管理员权限
}

// CustomerAuth 新增客户用户认证中间件
func CustomerAuth() gin.HandlerFunc {
    // 使用客户JWT密钥验证
    // 检查客户用户身份和状态
    // 从cu_users表验证用户
}
```


### 路由分组隔离

#### 路由前缀分离
- **管理员API**：`/api/*` - 系统管理功能
- **客户API**：`/api/cu/*` - 客户用户功能

#### 功能权限隔离
- 管理员可以访问所有系统功能
- 客户用户只能访问自己的数据和授权信息
- 企业管理员可以管理本企业的普通成员（不实现）
- 严格的数据隔离和权限控制

### Token机制分离

#### 独立的JWT配置
```yaml
# configs/config.yaml
jwt:
  admin:
    secret: "admin-jwt-secret-key"
    expire: 24h
  cu:  # 客户用户
    secret: "cu-jwt-secret-key"
    expire: 24h
```

#### Token格式差异
- 管理员Token：包含用户ID和角色信息
- 客户Token：包含用户ID和客户ID，确保数据隔离

## 数据库迁移

需要创建新的数据库迁移文件：

```sql
-- migrations/007_create_cu_users_table.sql
-- 创建customer_users表及相关索引和外键约束

-- 同时需要考虑短信验证码相关的配置表（如有需要）
-- migrations/008_add_sms_config.sql （可选）
```

## 架构设计方案

基于现有Clean Architecture，采用**共享架构，分组隔离**的设计方案：

### 总体原则
- 保持现有架构不变，避免过度分离
- 通过路由组实现逻辑隔离
- 共享核心组件，减少重复代码
- 认证逻辑独立，Token机制分离

### 目录结构规划

```
backend/
├── internal/
│   ├── api/
│   │   ├── handlers/
│   │   │   ├── auth_handler.go              # 保持（管理员登录）
│   │   │   ├── cu_auth_handler.go           # 新增（客户用户注册/登录）
│   │   │   ├── cu_profile_handler.go        # 新增（客户用户个人信息）
│   │   │   ├── customer_handler.go          # 保持
│   │   │   ├── license_handler.go           # 保持
│   │   │   └── ...
│   │   ├── middleware/
│   │   │   ├── auth.go                      # 扩展：添加CustomerAuth函数
│   │   │   ├── cors.go
│   │   │   └── ...
│   │   └── routes/
│   │       └── router.go                    # 扩展：区分admin和customer路由组
│   ├── service/
│   │   ├── cu_user_service.go               # 新增（客户用户业务逻辑）
│   │   └── ...
│   ├── repository/
│   │   ├── cu_user_repository.go            # 新增（客户用户数据访问）
│   │   └── ...
│   └── models/
│       ├── cu_user.go                       # 新增（客户用户数据模型）
│       └── ...
├── pkg/
│   └── sms/                                 # 新增（短信服务工具包）
└── configs/
    └── config.yaml                          # 扩展：添加客户用户相关配置项
```

### 路由分组设计

```go
// internal/api/routes/router.go
func SetupRouter() *gin.Engine {
    router := gin.New()

    // 管理员API组 - /api/*
    adminGroup := router.Group("/api")
    adminGroup.Use(middleware.AdminAuth()) // 原有管理员认证
    {
        adminGroup.POST("/auth/login", handlers.AdminLogin)
        adminGroup.GET("/customers", handlers.GetCustomers)
        // ... 其他管理员API
    }

    // 客户用户API组 - /api/cu/*
    customerGroup := router.Group("/api/cu")
    customerGroup.Use(middleware.CustomerAuth()) // 新增客户认证
    {
        customerGroup.POST("/auth/register", handlers.CuUserRegister)
        customerGroup.POST("/auth/login", handlers.CuUserLogin)
        customerGroup.POST("/auth/forgot-password", handlers.CuUserForgotPassword)
        customerGroup.POST("/auth/reset-password", handlers.CuUserResetPassword)
        customerGroup.GET("/profile", handlers.GetCuUserProfile)
        customerGroup.PUT("/profile", handlers.UpdateCuUserProfile)
        customerGroup.PUT("/profile/phone", handlers.UpdateCuUserPhone)
        // ... 其他客户用户API
    }

    return router
}
```

## 实现计划

### 第一阶段：基础设施搭建
1. 创建cu_前缀的文件结构
2. 实现短信验证码服务
3. 创建cu_users数据模型和迁移
4. 配置独立的JWT密钥和Token机制

### 第二阶段：核心认证功能
1. 实现手机号注册API（短信验证码验证）
2. 实现手机号登录API（短信验证码登录）
3. 构建独立的认证中间件
4. 实现客户用户路由隔离机制

### 第三阶段：用户管理功能
1. 实现用户信息管理API
2. 添加用户偏好设置功能
3. 实现密码管理功能（忘记密码、重置密码）
4. 实现手机号修改功能（新旧手机号验证）
5. 完善安全监控机制
6. 集成登录历史和IP追踪

## 技术要点

### 短信服务集成
- 支持主流短信服务商（阿里云、腾讯云等）
- 验证码存储在Redis中，确保高性能和自动过期
- 验证码生成和验证逻辑
- 频率限制和防刷机制

### Redis缓存策略
- 短信验证码：`sms:{type}:{phone}`格式存储，5分钟过期
- 使用后立即删除，防止重复使用
- 支持分布式部署的一致性

### 安全考虑
- 手机号数据加密存储
- 独立的Token密钥管理
- 请求频率限制
- 异常登录检测和告警
- 密码安全策略（强度要求、定期更新）

### 配置管理
- 客户用户模块配置文件
- 环境区分（开发/测试/生产）
- 敏感信息加密存储

### 文件命名规范
- 客户用户相关文件统一使用`cu_`前缀
- 清晰区分客户用户逻辑与管理员逻辑
- 便于代码维护和功能扩展

## 验收标准

### 功能验收
- [ ] 客户自主注册流程完整（短信验证码）
- [ ] 手机号+密码登录功能正常
- [ ] 忘记密码重置流程完整
- [ ] 用户角色权限控制正确（admin/member）
- [ ] 手机号修改流程安全（新旧手机号验证）
- [ ] Redis验证码存储和验证正常
- [ ] 路由隔离正确（/api/ vs /api/cu/）

### 性能验收
- [ ] API响应时间符合要求
- [ ] Redis操作性能良好
- [ ] 并发访问稳定

### 安全验收
- [ ] 密码加密存储安全
- [ ] JWT Token隔离正确
- [ ] 短信验证码防刷机制有效
- [ ] 数据隔离完整