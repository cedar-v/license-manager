# 设备管理

## 概述

设备管理是为客户用户提供的功能，用户可以在客户端查看和管理自己激活授权码的设备信息。

**核心业务逻辑：**
- 用户激活授权码后，设备会在平台生成许可证记录
- 一个客户可以有多个设备（受每个授权码的`max_activations`限制）
- 设备支持解绑操作，解绑后可以用授权码在其他设备重新激活

## 相关表结构

### licenses 表（许可证表）
```sql
CREATE TABLE `licenses` (
  `id` varchar(36) NOT NULL,
  `license_key` varchar(200) NOT NULL,
  `authorization_code_id` varchar(36) NOT NULL,
  `customer_id` varchar(36) NOT NULL,
  `hardware_fingerprint` varchar(200) NOT NULL,
  `device_info` json DEFAULT NULL,
  `activation_ip` varchar(45) DEFAULT NULL,
  `status` varchar(20) NOT NULL DEFAULT 'inactive',
  `activated_at` datetime(3) DEFAULT NULL,
  `last_heartbeat` datetime(3) DEFAULT NULL,
  `last_online_ip` varchar(45) DEFAULT NULL,
  `config_updated_at` datetime(3) DEFAULT NULL,
  `usage_data` json DEFAULT NULL,
  `created_at` datetime(3) NOT NULL,
  `updated_at` datetime(3) NOT NULL,
  `deleted_at` datetime(3) DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_licenses_license_key` (`license_key`),
  KEY `idx_licenses_authorization_code_id` (`authorization_code_id`),
  KEY `idx_licenses_customer_id` (`customer_id`),
  KEY `idx_licenses_hardware_fingerprint` (`hardware_fingerprint`),
  KEY `idx_licenses_status` (`status`),
  KEY `idx_licenses_activated_at` (`activated_at`),
  KEY `idx_licenses_last_heartbeat` (`last_heartbeat`),
  KEY `idx_licenses_config_updated_at` (`config_updated_at`),
  KEY `idx_licenses_created_at` (`created_at`),
  KEY `idx_licenses_deleted_at` (`deleted_at`),
  CONSTRAINT `fk_licenses_authorization_code` FOREIGN KEY (`authorization_code_id`) REFERENCES `authorization_codes` (`id`) ON DELETE CASCADE ON UPDATE RESTRICT,
  CONSTRAINT `fk_licenses_customer` FOREIGN KEY (`customer_id`) REFERENCES `customers` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
```

### authorization_codes 表（授权码表）
```sql
CREATE TABLE `authorization_codes` (
  `id` varchar(36) NOT NULL,
  `code` varchar(1000) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL,
  `customer_id` varchar(36) NOT NULL,
  `created_by` varchar(36) NOT NULL,
  `software_id` varchar(50) DEFAULT NULL,
  `description` text,
  `start_date` datetime(3) NOT NULL,
  `end_date` datetime(3) NOT NULL,
  `deployment_type` varchar(20) NOT NULL DEFAULT 'standalone',
  `encryption_type` varchar(20) DEFAULT 'standard',
  `software_version` varchar(50) DEFAULT NULL,
  `max_activations` bigint NOT NULL DEFAULT '1',
  `is_locked` tinyint(1) NOT NULL DEFAULT '0',
  `lock_reason` text,
  `locked_at` datetime(3) DEFAULT NULL,
  `locked_by` varchar(36) DEFAULT NULL,
  `feature_config` json DEFAULT NULL,
  `usage_limits` json DEFAULT NULL,
  `custom_parameters` json DEFAULT NULL,
  `created_at` datetime(3) NOT NULL,
  `updated_at` datetime(3) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_authorization_codes_customer_id` (`customer_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
```

## 配置要求

使用现有的心跳超时配置来判断设备在线状态：

```yaml
license:
  heartbeat_timeout: 300  # 心跳超时时间(秒)，超过此时间未上报心跳视为离线
```

## API 接口

### 1. 获取设备列表

**接口路径：** `GET /api/cu/devices`

**功能：** 根据用户token获取该客户的所有设备列表

**查询参数：**
- `page` (integer, optional): 页码，默认1
- `page_size` (integer, optional): 每页数量，默认20，最大100
- `device_name` (string, optional): 设备名称模糊搜索（匹配device_info中的name字段）
- `authorization_code_id` (string, optional): 按授权码ID筛选设备

**返回数据：**
```json
{
  "code": "200",
  "message": "success",
  "data": {
    "total": 25,
    "page": 1,
    "page_size": 20,
    "list": [
      {
        "id": "license-uuid",
        "device_info": {
          "name": "我的电脑",
          "os": "Windows 11",
          "cpu": "Intel i7",
          "memory": "16GB"
        },
        "is_online": true,
        "last_online_ip": "192.168.1.100",
        "last_heartbeat": "2026-01-03T10:30:00Z",
        "activated_at": "2026-01-01T09:00:00Z",
        "authorization_info": {
          "authorization_code": "LIC-ABC123-XXXX...",
          "authorization_code_id": "auth-code-uuid",
          "end_date": "2026-12-31T23:59:59Z",
          "description": "基础版许可"
        }
      }
    ]
  }
}
```

**业务逻辑：**
1. 从用户token解析得到`customer_id`
2. 查询该客户的所有有效许可证（status='active'且未删除）
3. 支持按授权码ID筛选（可选）
4. 支持分页和设备名称模糊搜索
5. 在线状态计算：当前时间 - last_heartbeat < heartbeat_timeout（配置为300秒）
6. 授权信息通过关联`authorization_codes`表获取

### 2. 解绑设备

**接口路径：** `DELETE /api/cu/devices/{id}`

**功能：** 解绑指定设备，物理删除许可证记录

**路径参数：**
- `id` (string, required): 许可证ID

**返回数据：**
```json
{
  "code": "200",
  "message": "设备解绑成功"
}
```

**业务逻辑：**
1. 验证许可证ID存在且属于当前客户
2. 物理删除许可证记录（DELETE操作）
3. 删除后用户可以用该授权码在其他设备重新激活
4. `max_activations`限制检查在激活时处理，不在此接口处理

