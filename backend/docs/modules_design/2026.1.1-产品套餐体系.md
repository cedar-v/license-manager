# 产品套餐体系设计

## 需求概述

构建套餐购买和授权管理系统，支持客户自主选择套餐、生成授权码的业务流程。

**核心要求：**
- 支持三种套餐类型：试用版、基础版、专业版
- 实现阶梯定价折扣机制（基于许可数量，通过配置化JSON实现）
- 自动生成授权码（一个订单对应一个授权码，激活次数由许可数量决定）
- 支付流程暂时用伪代码实现
- 保证授权码的安全性和唯一性

**重要概念说明：**
- **许可数量**：等于设备数量，决定授权码可以激活多少次
- **试用版**：1个授权码，许可数量为1，用户每月限购1个
- **基础版/专业版**：1个授权码，许可数量等于购买数量，支持50-99、100-499、500+许可的阶梯折扣

## 业务流程

### 整体购买流程
1. 用户登录客户用户系统
2. 浏览套餐列表和价格信息
3. 选择套餐类型和许可数量
4. 系统计算折扣和总价
5. 用户确认并支付（支付成功后直接创建订单）
6. 系统生成授权码并返回给用户
7. 支付失败或取消：不创建订单，用户可重新下单

### 简化流程说明
- **试用版**：直接生成授权码，无需支付
- **基础版/专业版**：使用伪代码模拟支付成功，然后生成授权码
- **一个订单**：对应一个授权码，数量字段仅用于价格计算

## 套餐类型详细说明

| 套餐类型 | 授权期限 | 单价(元)/许可 | 许可数量 | 功能限制 | 适用场景 |
|---------|---------|----------|---------|---------|---------|
| 试用版 | 当天至本月25日 | 0 | 1 | 全部功能 | 新用户试用体验 |
| 基础版 | 永久授权 | 300 | 按购买数量 | 部分功能限制 | 小型企业入门 |
| 专业版 | 永久授权 | 2000 | 按购买数量 | 全部功能 | 中大型企业使用 |

### 功能限制说明

**试用版：**
- 全部功能开放，无任何限制
- 时效性：每月1-25日可购买，当月25日到期
- 不可批量购买，数量固定为1

**基础版：**
- 限制同时在线设备数量（具体数量待定）
- 限制某些高级功能的使用
- 支持批量购买，享受阶梯折扣

**专业版：**
- 全部功能开放，无任何限制
- 支持批量购买，企业级折扣
- 包含优先技术支持服务

## 购买规则和限制

### 折扣规则
- **默认价格**：单个许可不享受折扣
- **9折优惠**：购买50-99个许可
- **8折优惠**：购买100-499个许可
- **7折优惠**：购买500个及以上许可

### 试用版特殊规则
- **购买时间限制**：每月1-25日可购买，26-31日不可购买
- **授权期限**：从购买当天到当月25日23:59:59
- **许可数量**：固定为1（只能激活1次）
- **用户限制**：每个用户每月只能购买1个试用版授权码
- **重复购买**：次月可重新购买，不限制购买次数

### 基础版/专业版规则
- **许可数量选择**：支持选择1-1000个许可数量
- **激活次数限制**：授权码的激活次数等于购买的许可数量
- **折扣计算**：基于许可总数量计算折扣，按单价折扣
- **授权期限**：购买后永久有效，无到期时间限制

### 通用限制
- **用户限制**：每个客户用户账号可独立购买，不受其他账号影响
- **支付限制**：必须完成支付后才能生成授权码
- **退款政策**：购买后不支持退款，建议谨慎选择

## 套餐配置设计

### 写死JSON配置结构

套餐信息通过代码中的JSON配置实现，便于后续修改：

```go
// pkg/config/packages.go
type PackageConfig struct {
    Packages []Package `json:"packages"`
    Discounts []DiscountRule `json:"discounts"`
}

type Package struct {
    ID           string  `json:"id"`
    Name         string  `json:"name"`
    Type         string  `json:"type"`         // trial, basic, professional
    Price        float64 `json:"price"`
    DurationDays *int    `json:"duration_days"` // null表示永久
    MaxDevices   *int    `json:"max_devices"`   // null表示无限制
    Features     map[string]interface{} `json:"features"`
    Status       string  `json:"status"`       // active, disabled
    SortOrder    int     `json:"sort_order"`
}

type DiscountRule struct {
    MinQuantity int     `json:"min_quantity"`
    MaxQuantity *int    `json:"max_quantity"` // null表示无上限
    Rate        float64 `json:"rate"`
    Description string  `json:"description"`
}

// 写死配置数据
var DefaultPackageConfig = PackageConfig{
    Packages: []Package{
        {
            ID:          "trial",
            Name:        "试用版",
            Type:        "trial",
            Price:       0,     // 免费
            DurationDays: nil,  // 动态计算到当月25日
            MaxDevices:  nil,   // 无设备限制
            Features:    map[string]interface{}{"full_access": true},
            Status:      "active",
            SortOrder:   1,
        },
        {
            ID:          "basic",
            Name:        "基础版",
            Type:        "basic",
            Price:       300,   // 每许可300元
            DurationDays: nil,  // 永久
            MaxDevices:  nil,   // 激活次数由购买数量决定
            Features:    map[string]interface{}{"basic_features": true},
            Status:      "active",
            SortOrder:   2,
        },
        {
            ID:          "professional",
            Name:        "专业版",
            Type:        "professional",
            Price:       2000,  // 每许可2000元
            DurationDays: nil,  // 永久
            MaxDevices:  nil,   // 激活次数由购买数量决定
            Features:    map[string]interface{}{"full_access": true, "priority_support": true},
            Status:      "active",
            SortOrder:   3,
        },
    },
    // 折扣规则：基于许可数量
    Discounts: []DiscountRule{
        {MinQuantity: 50, MaxQuantity: &[]int{99}[0], Rate: 0.9, Description: "50-99许可9折优惠"},
        {MinQuantity: 100, MaxQuantity: &[]int{499}[0], Rate: 0.8, Description: "100-499许可8折优惠"},
        {MinQuantity: 500, MaxQuantity: nil, Rate: 0.7, Description: "500+许可7折优惠"},
    },
}
```

## 数据模型设计

### 订单表 (orders)
```sql
CREATE TABLE orders (
    id VARCHAR(36) PRIMARY KEY DEFAULT (UUID()),
    order_no VARCHAR(50) NOT NULL COMMENT '订单号',
    customer_id VARCHAR(36) NOT NULL COMMENT '客户ID',
    cu_user_id VARCHAR(36) NOT NULL COMMENT '客户用户ID',
    package_id VARCHAR(50) NOT NULL COMMENT '套餐ID (对应配置中的ID)',
    package_name VARCHAR(100) NOT NULL COMMENT '套餐名称(快照)',
    license_count INT NOT NULL COMMENT '许可数量(可激活次数)',
    unit_price DECIMAL(10,2) NOT NULL COMMENT '单价(每许可价格，快照)',
    discount_rate DECIMAL(3,2) NOT NULL DEFAULT 1.0 COMMENT '折扣率',
    total_amount DECIMAL(10,2) NOT NULL COMMENT '订单总金额',
    status VARCHAR(20) NOT NULL DEFAULT 'pending' COMMENT '订单状态: pending-待支付, paid-已支付, cancelled-已取消, expired-已过期',
    authorization_code VARCHAR(50) NULL COMMENT '生成的授权码',
    expired_at DATETIME(3) NULL COMMENT '订单过期时间',
    created_at DATETIME(3) NOT NULL,
    updated_at DATETIME(3) NOT NULL,
    deleted_at DATETIME(3) NULL,

    FOREIGN KEY (customer_id) REFERENCES customers(id),
    FOREIGN KEY (cu_user_id) REFERENCES cu_users(id)
);
```

**说明：**
- 一个订单对应一个授权码，`license_count`字段表示许可数量
- `authorization_code`字段存储生成的授权码
- 授权码创建时会设置许可数量限制

## API接口设计

### 1. 获取套餐列表
```
GET /api/cu/packages
```
**响应：**
```json
{
  "code": "000000",
  "message": "成功",
  "data": [
    {
      "id": "trial",
      "name": "试用版",
      "type": "trial",
      "price": 0,
      "max_devices": 1,
      "description": "免费试用，有效期至本月25日"
    },
    {
      "id": "basic",
      "name": "基础版",
      "type": "basic",
      "price": 300,
      "max_devices": 1000,
      "description": "基础功能，支持批量许可购买"
    },
    {
      "id": "professional",
      "name": "专业版",
      "type": "professional",
      "price": 2000,
      "max_devices": 1000,
      "description": "全部功能，支持批量许可购买"
    }
  ]
}
```

### 2. 计算订单价格
```
POST /api/cu/orders/calculate
```
**请求：**
```json
{
  "package_id": "basic",
  "license_count": 100
}
```
**响应：**
```json
{
  "code": "000000",
  "message": "成功",
  "data": {
    "unit_price": 300.00,
    "license_count": 100,
    "discount_rate": 0.8,
    "total_amount": 24000.00,
    "discount_description": "100-499许可8折优惠"
  }
}
```

### 3. 创建订单
```
POST /api/cu/orders
```
**请求：**
```json
{
  "package_id": "basic",
  "license_count": 100
}
```
**响应：**
```json
{
  "code": "000000",
  "message": "成功",
  "data": {
    "order_id": "order_id_123",
    "order_no": "ORD202401010001",
    "total_amount": 24000.00,
    "status": "paid",
    "authorization_code": "AC-240101-A1B2C3D4",
    "expired_at": null
  }
}
```

### 4. 获取订单详情
```
GET /api/cu/orders/{order_id}
```
返回订单状态和授权码信息。

### 5. 获取用户订单历史
```
GET /api/cu/orders
```
返回用户的订单历史记录。

## 前端交互需求

### 套餐选择页面
- 展示三种套餐类型的详细信息
- 支持数量选择（试用版除外）
- 实时计算折扣和总价
- 显示购买限制和规则说明

### 订单确认页面
- 显示订单详情和价格明细
- 提供支付方式选择
- 显示订单过期时间提醒

### 支付结果页面
- 显示支付状态
- 支付成功后展示生成的授权码
- 提供授权码下载/复制功能

### 订单历史页面
- 显示用户的所有订单记录
- 支持按状态筛选
- 显示授权码详情和使用情况

## 支付集成 (暂时用伪代码实现)

### 支付流程说明
由于支付功能暂时不实现，使用伪代码直接模拟支付成功：

```go
// 伪代码：模拟支付流程
func simulatePayment(order *Order) error {
    // TODO: 替换为真实的支付接口
    // 1. 调用第三方支付接口
    // 2. 返回支付链接或二维码
    // 3. 等待支付回调

    // 暂时直接标记为支付成功
    order.Status = "paid"
    order.AuthorizationCode = generateAuthorizationCode()

    return nil
}
```

### 支付状态流转
1. **所有订单**：创建时即为已支付状态
2. **试用版**：免费，无需支付流程
3. **基础版/专业版**：支付成功后创建订单，失败则不创建
4. **无中间状态**：要么创建成功（已支付），要么失败不创建

### 未来扩展点
- 集成支付宝/微信支付SDK
- 实现支付回调接口
- 添加支付超时和失败处理
- 实现退款功能

## 授权码生成逻辑

### 授权码生成流程
1. 根据套餐类型从配置中获取授权参数
2. 生成唯一的授权码（格式：AC-年月日-8位随机数）
3. 设置授权期限和许可数量限制
4. 创建订单记录和授权码记录

### 授权码格式规范
- **前缀**：AC (Authorization Code)
- **日期**：YYMMDD格式（如240101）
- **随机数**：8位数字字母组合（排除容易混淆的字符如0、O、I、1）
- **示例**：AC-240101-A1B2C3D4

### 试用版特殊处理
- **购买限制**：每个用户每月只能有一个试用版授权码
- **时间限制**：每月1-25日可购买，26-31日不可购买
- **到期时间**：购买当月25日23:59:59
- **许可数量**：固定为1（只能激活1次）
- **重复购买**：次月可重新购买，不限制购买次数



**说明：** 由于一个订单对应一个授权码，不再需要批量生成逻辑。

## 数据库设计

### 新增表
1. **orders** - 订单表

### 索引设计
```sql
-- orders表索引
CREATE INDEX idx_orders_customer_id ON orders(customer_id);
CREATE INDEX idx_orders_cu_user_id ON orders(cu_user_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_created_at ON orders(created_at);
CREATE INDEX idx_orders_package_id ON orders(package_id);
```

## 错误处理

### 业务错误码 (60xxxx)
```yaml
# 套餐相关错误
cu_package:
  "600001": "套餐不存在"
  "600002": "套餐已下架"
  "600003": "试用版购买时间限制"
  "600004": "试用版不支持批量购买"
  "600005": "当月已购买试用版"

# 订单相关错误
cu_order:
  "601001": "订单不存在"
  "601005": "许可数量超出限制"

# 支付相关错误
cu_payment:
  "602001": "支付失败"
  "602002": "支付金额不匹配"
  "602003": "重复支付"
```

## 多语言支持

### 套餐名称国际化
```yaml
packages:
  trial: "试用版"
  basic: "基础版"
  professional: "专业版"
```

### 折扣说明国际化
```yaml
discounts:
  no_discount: "不享受折扣"
  discount_9: "9折优惠 (50-99个)"
  discount_8: "8折优惠 (100-499个)"
  discount_7: "7折优惠 (500个以上)"
```

## 技术实现要点

### 订单号生成
- 格式：ORD + 年月日 + 6位序列号
- 保证全局唯一性
- 支持高并发生成

### 折扣计算逻辑
基于许可数量的配置化折扣规则：

```go
func calculateDiscount(config PackageConfig, licenseCount int) (rate float64, description string) {
    for _, rule := range config.Discounts {
        if licenseCount >= rule.MinQuantity {
            if rule.MaxQuantity == nil || licenseCount <= *rule.MaxQuantity {
                return rule.Rate, rule.Description
            }
        }
    }
    return 1.0, "不享受折扣"
}
```

### 试用版时间限制检查
```go
func canPurchaseTrial() bool {
    now := time.Now()
    // 每月1-25日可购买
    return now.Day >= 1 && now.Day <= 25
}

func getTrialExpiryTime() time.Time {
    now := time.Now()
    // 当月25日23:59:59
    return time.Date(now.Year(), now.Month(), 25, 23, 59, 59, 0, now.Location())
}
```

### 授权码生成
```go
func generateAuthorizationCode() string {
    now := time.Now()
    dateStr := now.Format("060102") // YYMMDD格式

    // 生成8位随机字符串（数字+字母，排除易混淆字符）
    const charset = "23456789ABCDEFGHJKMNPQRSTUVWXYZ"
    code := make([]byte, 8)
    for i := range code {
        code[i] = charset[rand.Intn(len(charset))]
    }

    return fmt.Sprintf("AC-%s-%s", dateStr, string(code))
}
```

### 订单号生成
```go
func generateOrderNo() string {
    now := time.Now()
    dateStr := now.Format("20060102") // YYYYMMDD格式

    // 使用原子计数器生成6位序列号
    sequence := atomic.AddUint64(&orderSequence, 1) % 1000000

    return fmt.Sprintf("ORD%s%06d", dateStr, sequence)
}
```

## 验收标准

### 功能验收
- [x] 套餐列表接口正确返回三种套餐信息（公开接口，无需认证）
- [x] 价格计算接口正确处理折扣逻辑
- [x] 订单创建接口完整实现业务流程
- [x] 获取订单详情接口支持权限验证
- [x] 获取用户订单历史接口支持分页
- [ ] 试用版购买时间限制生效
- [ ] 试用版每月限购一个的检查逻辑正确
- [ ] 授权码生成正确（包含激活次数限制）
- [x] 订单创建即为已支付状态，无需状态更新
- [ ] 授权码格式规范统一

### 性能验收
- [ ] 订单创建响应时间 < 500ms
- [ ] 授权码生成 < 100ms
- [ ] 高并发订单处理稳定
- [ ] 数据库查询性能良好

### 安全验收
- [ ] 订单金额验证严格
- [ ] 防止重复生成授权码
- [ ] 授权码唯一性保证
- [ ] 敏感信息处理安全

### 业务验收
- [ ] 折扣规则计算准确（基于许可数量和配置JSON）
- [ ] 试用版期限设置正确（当月25日）
- [ ] 试用版用户每月限购一个
- [ ] 永久版无到期时间限制
- [ ] 许可数量设置正确（试用版1，其他版等于购买数量）
- [ ] 一个订单对应一个授权码

