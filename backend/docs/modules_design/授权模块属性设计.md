# 授权管理模块属性设计

## 整体架构说明

授权管理采用两层架构模式：
1. **授权码 (authorization_codes)** - 业务配置的容器，包含功能权限、使用限制等
2. **许可证 (licenses)** - 硬件激活凭证，只表示哪台机器有权使用该授权

### 关系映射
```
授权码 (1) → 许可证 (N)
```
一个授权码定义业务规则，多个许可证表示可以在多台机器上使用

### 数据流向
```
授权码(业务配置模板) → 许可证(完整配置+硬件绑定) → 软件本地许可证文件 → 软件运行时使用
```

### 通信流程
1. **软件启动**: 读取本地许可证文件（包含完整配置）
2. **定期心跳**: 携带授权码和硬件指纹查询状态
3. **配置更新**: 如授权码配置有更新，平台返回新的许可证文件
4. **离线运行**: 软件使用本地许可证文件继续运行（在有效期内）
5. **许可证管理**: 新硬件请求时自动生成许可证（未超max_activations限制）

---

## 1. 授权码表 (authorization_codes)

### 基础信息属性
- `id` - 主键
- `code` - 唯一授权码 (软件身份凭证，可重复使用)
- `customer_id` - 关联客户ID
- `software_id` - 目标软件产品ID(企业版)
- `created_by` - 创建人ID
- `created_at/updated_at` - 时间戳

### 授权核心属性
- `start_date` - 授权开始时间
- `end_date` - 授权结束时间
- `software_version` - 支持的软件版本范围（企业版）
- `deployment_type` - 部署类型 (standalone/cloud/hybrid)
- `encryption_type` - 加密类型 (standard/advanced)

### 激活控制属性
- `max_activations` - 最大许可证数量
- `current_activations` - 当前已激活数量（可通过关联查询获得）

### 状态管理属性
- `status` - 授权状态 (active/expired/suspended/locked)
- `lock_reason` - 锁定原因 (security/violation/maintenance/expired)
- `lock_type` - 锁定类型 (full/partial)
- `locked_features` - 被锁定的功能列表 (JSON)（企业版）
- `locked_at` - 锁定时间
- `locked_by` - 锁定操作人

### 通用功能控制属性
- `feature_config` - 功能配置 (JSON格式，完全自定义)
- `usage_limits` - 使用量限制 (JSON格式，如用户数、API调用次数等)
- `custom_parameters` - 自定义参数 (JSON格式，软件特定的配置)


---

## 2. 许可证表 (licenses)

### 基础信息属性
- `id` - 主键
- `license_key` - 许可证密钥 (设备特定)
- `authorization_code` - 关联的授权码 (外键)
- `customer_id` - 客户ID (冗余字段，便于查询)
- `created_at/updated_at` - 时间戳

### 硬件绑定属性
- `hardware_fingerprint` - 绑定的硬件指纹
- `device_info` - 设备信息 (JSON格式，包含CPU、内存等)
- `activation_ip` - 激活时的IP地址

### 激活状态属性
- `status` - 许可证状态 (active/inactive/revoked)
- `activated_at` - 激活时间
- `last_heartbeat` - 最后心跳时间
- `is_online` - 在线状态
- `last_online_ip` - 最后在线IP

### 授权配置属性 (从授权码同步)
- `start_date` - 授权开始时间
- `end_date` - 授权结束时间
- `software_version` - 支持的软件版本范围
- `deployment_type` - 部署类型 (standalone/cloud/hybrid)
- `encryption_type` - 加密类型 (standard/advanced)
- `feature_config` - 功能配置 (JSON格式，完全自定义)
- `usage_limits` - 使用量限制 (JSON格式，如用户数、API调用次数等)
- `custom_parameters` - 自定义参数 (JSON格式，软件特定的配置)

### 状态管理属性
- `lock_status` - 锁定状态 (normal/locked)
- `lock_reason` - 锁定原因 (security/violation/maintenance/expired)
- `lock_type` - 锁定类型 (full/partial)
- `locked_features` - 被锁定的功能列表 (JSON)
- `locked_at` - 锁定时间
- `locked_by` - 锁定操作人

### 使用统计属性
- `current_user_count` - 当前用户数量 (软件上报)
- `current_device_count` - 当前设备数量 (软件上报)  
- `last_usage_report` - 最后使用情况报告 (JSON)

---

## 3. 授权变更历史表 (authorization_changes)

### 基础属性
- `id` - 主键
- `authorization_code_id` - 授权码ID
- `change_type` - 变更类型 (renewal/upgrade/limit_change/feature_toggle/lock/unlock)
- `old_config` - 变更前配置 (JSON)
- `new_config` - 变更后配置 (JSON)
- `effective_at` - 生效时间
- `operator_id` - 操作人ID
- `reason` - 变更原因
- `created_at` - 记录创建时间

---

## 4. 授权通知表 (authorization_notifications)

### 基础属性
- `id` - 主键
- `authorization_code_id` - 授权码ID
- `notification_type` - 通知类型 (expiry_warning/limit_reached/status_change/activation_limit)
- `message` - 通知消息
- `sent_at` - 发送时间
- `recipient_type` - 接收人类型 (admin/customer/support)
- `recipient_id` - 接收人ID
- `is_read` - 是否已读

---

## 5. 授权日志表 (authorization_logs)

### 基础属性
- `id` - 主键
- `authorization_code` - 授权码
- `license_id` - 许可证ID (可为空)
- `action_type` - 操作类型 (license_request/heartbeat/validation/config_check/activation_attempt)
- `result` - 操作结果 (success/failure/rejected)
- `client_ip` - 客户端IP
- `hardware_fingerprint` - 硬件指纹
- `client_info` - 客户端信息 (JSON)
- `error_message` - 错误信息
- `created_at` - 日志时间

---

## 软件运行机制

### 启动流程
1. **读取许可证文件**: 加载本地许可证文件（包含完整配置）
2. **配置验证**: 检查授权有效期和功能权限
3. **应用配置**: 根据feature_config启用/禁用功能模块
4. **开始运行**: 按usage_limits控制资源使用

### 心跳流程
1. **发送心跳**: 携带授权码 + 硬件指纹 + 使用统计
2. **配置检查**: 平台比较授权码updated_at与许可证updated_at判断是否有更新
3. **返回响应**: 
   - 如有更新：返回新的许可证文件
   - 无更新：返回状态确认和下次心跳间隔
4. **更新许可证**: 软件替换本地许可证文件

### 许可证生成逻辑
1. **请求验证**: 软件发送授权码 + 硬件指纹
2. **授权码检查**: 验证授权码有效性和状态  
3. **许可证查找**: 检查该硬件是否已有许可证
4. **数量限制检查**: 如果是新硬件，检查当前激活数 < max_activations
5. **许可证生成**: 通过检查后自动生成新许可证（包含完整配置）
6. **返回数据**: 返回许可证文件

### 配置同步机制
1. **管理员修改授权码配置**: 更新authorization_codes表
2. **触发许可证更新**: 批量更新所有关联许可证的配置字段
3. **心跳时推送**: 客户端心跳时检测到更新，下载新许可证文件
4. **应用新配置**: 软件使用新许可证文件中的配置

### 并发控制
```sql
-- 原子性操作：检查并生成许可证
BEGIN TRANSACTION;
SELECT COUNT(*) FROM licenses WHERE authorization_code = ? AND status = 'active';
-- 如果未超限，则INSERT新许可证（包含从授权码复制的完整配置）
INSERT INTO licenses (...) VALUES (...);
COMMIT;
```

### 离线运行支持
1. **自包含许可证**: 许可证文件包含完整配置，支持完全离线运行
2. **有效期检查**: 软件自行验证授权是否在有效期内
3. **功能控制**: 根据许可证文件中的配置控制功能可用性
4. **网络恢复**: 连网后自动同步最新许可证文件

### 业务场景支持
1. **多机部署** - 同一授权码在不同硬件上自动激活
2. **离线运行** - 软件使用本地许可证文件运行
3. **配置更新** - 授权码配置变更，心跳时推送新许可证文件给所有激活设备
4. **数量控制** - 通过max_activations控制并发许可证数量
5. **硬件更换** - 新硬件指纹触发新许可证生成