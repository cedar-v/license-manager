# 授权管理模块属性设计

## 整体架构说明

授权管理采用两层架构模式：
1. **授权码 (authorization_codes)** - 业务配置的容器，包含功能权限、使用限制等
2. **许可证 (licenses)** - 硬件激活凭证，只表示哪台机器有权使用该授权

### 关系映射
```
授权码 (1) → 许可证 (N)
```
一个授权码定义业务规则，多个许可证表示可以在多台机器上使用

### 数据流向
```
授权码(业务配置模板) → 许可证(硬件绑定) → 软件本地许可证文件(包含完整配置) → 软件运行时使用
```


---

## 1. 授权码表 (authorization_codes)

### 基础信息属性
- `id` - 主键
- `code` - 唯一授权码 (软件身份凭证，可重复使用)
- `customer_id` - 关联客户ID
- `created_by` - 创建人ID
- `created_at/updated_at` - 时间戳
- `software_id` - 目标软件产品ID(企业版)
- `description` - 描述

### 授权核心属性
- `start_date` - 授权开始时间
- `end_date` - 授权结束时间
- `deployment_type` - 部署类型 (standalone单机版/cloud云端版/hybrid混合版)
- `encryption_type` - 加密类型 (standard标准加密/advanced高级加密)(企业版)
- `software_version` - 支持的软件版本范围（企业版）

### 激活控制属性
- `max_activations` - 最大许可证数量
- `current_activations` - 当前已激活数量（可通过关联查询获得）

### 状态管理属性
- （虚字段-不出现在表中）`status` - 授权状态 (normal正常/locked已锁定/expired已过期)
  - **SQL 计算逻辑**:
    ```sql
    CASE 
      WHEN is_locked = true THEN 'locked'
      WHEN end_date < NOW() THEN 'expired'
      WHEN start_date <= NOW() AND end_date >= NOW() THEN 'normal'
      ELSE 'expired'
    END AS status
    ```
  - **优先级**: locked > expired > normal
  - **筛选实现**: 在 WHERE 子句中使用相同逻辑进行条件判断
- `is_locked` - 是否被锁定 (布尔字段)
- `lock_reason` - 锁定原因 (自定义文本输入)
- `locked_at` - 锁定时间
- `locked_by` - 锁定操作人

### 通用功能控制属性
- `feature_config` - 功能配置 (JSON格式，软件产品基础功能)
- `usage_limits` - 使用量限制 (JSON格式，如用户数、API调用次数等)
- `custom_parameters` - 自定义参数 (JSON格式，软件特定功能或用户定制功能)


---

## 2. 许可证表 (licenses)

### 基础信息属性
- `id` - 主键
- `license_key` - 许可证密钥 (设备特定)
- `authorization_code_id` - 关联的授权码 (外键)
- `customer_id` - 客户ID (冗余字段，便于查询)
- `created_at/updated_at` - 时间戳

### 硬件绑定属性
- `hardware_fingerprint` - 绑定的硬件指纹
- `device_info` - 设备信息 (JSON格式，包含CPU、内存等)
- `activation_ip` - 激活时的IP地址

### 激活状态属性
- `status` - 许可证状态 (active激活/inactive未激活/revoked已撤销)
   - 硬件更换 - 用户换了新设备，需要撤销旧设备的许可证
   - 设备丢失/损坏 - 设备不再使用，主动释放许可证名额
   - 违规使用 - 发现设备被盗用或滥用，管理员撤销
- `activated_at` - 激活时间
- `last_heartbeat` - 最后心跳时间
- （虚字段）`is_online` - 在线状态
- `last_online_ip` - 最后在线IP

### 配置同步属性
- `config_updated_at` - 配置更新时间

### 使用统计属性
- `usage_data` - 使用数据 (JSON格式，软件上报的统计信息)

---

## 3. 授权变更历史表 (authorization_changes)

当修改授权的时候，需要用户确认并选择变更类型和填写变更原因（非必输）

### 基础属性
- `id` - 主键
- `authorization_code_id` - 授权码ID
- `change_type` - 变更类型 (renewal续费/upgrade升级/limit_change限制调整/feature_toggle功能开关/lock锁定/unlock解锁/other其他)
- `old_config` - 变更前配置 (JSON)
- `new_config` - 变更后配置 (JSON)
- `operator_id` - 操作人ID
- `reason` - 变更原因
- `created_at` - 记录创建时间

---

## 软件运行机制

### 启动流程
1. **读取许可证文件**: 加载并解密本地许可证文件，验证数字签名防止篡改
2. **配置检查**: 
   - 如果联网，比较许可证内的 `config_updated_at` 与服务端 `updated_at`
   - 如有差异则下载新的加密许可证文件替换本地文件
3. **配置验证**: 检查许可证内的授权有效期和功能权限
4. **应用配置**: 根据许可证内的配置启用/禁用功能模块
5. **开始运行**: 按许可证配置限制控制资源使用

### 心跳流程
1. **发送心跳**: 携带授权码 + 硬件指纹 + 使用统计 + 许可证内的配置更新时间
2. **状态验证**: 服务端验证授权码和许可证状态
3. **配置比较**: 比较客户端上报的配置更新时间与服务端当前时间
4. **返回响应**: 
   - 如配置有更新：返回新的加密许可证文件
   - 无更新：仅返回状态确认和下次心跳间隔
5. **更新许可证**: 如有配置更新，客户端替换本地许可证文件

### 许可证生成逻辑
1. **请求验证**: 软件发送授权码 + 硬件指纹
2. **授权码检查**: 验证授权码有效性和状态  
3. **许可证查找**: 检查该硬件是否已有许可证
4. **数量限制检查**: 如果是新硬件，检查当前激活数 < max_activations
5. **许可证生成**: 生成包含完整配置的加密许可证文件
6. **返回数据**: 返回加密的许可证文件

### 配置同步机制
1. **管理员修改授权码配置**: 更新authorization_codes表，同时更新 `updated_at` 时间戳
2. **客户端检测**: 通过心跳或启动时比较许可证内的配置更新时间
3. **许可证更新**: 发现配置有更新时，客户端下载新的加密许可证文件
4. **文件替换**: 用新的许可证文件替换本地文件
5. **应用新配置**: 软件重新加载许可证文件中的配置

### 并发控制
```sql
-- 原子性操作：检查并生成许可证
BEGIN TRANSACTION;
SELECT COUNT(*) FROM licenses WHERE authorization_code = ? AND status = 'active';
-- 如果未超限，则INSERT新许可证
INSERT INTO licenses (license_key, authorization_code, hardware_fingerprint, config_updated_at, ...) VALUES (...);
COMMIT;
```

### 离线运行支持
1. **自包含许可证**: 许可证文件包含完整的加密配置信息
2. **有效期检查**: 软件自行验证许可证内的授权是否在有效期内
3. **功能控制**: 根据许可证文件中的配置控制功能可用性
4. **网络恢复**: 连网后通过心跳自动检查并更新许可证文件

### 业务场景支持
1. **多机部署** - 同一授权码在不同硬件上自动激活
2. **离线运行** - 软件使用许可证文件完全离线运行
3. **配置更新** - 授权码配置变更，心跳时推送新许可证文件给所有激活设备
4. **数量控制** - 通过max_activations控制并发许可证数量
5. **硬件更换** - 新硬件指纹触发新许可证生成