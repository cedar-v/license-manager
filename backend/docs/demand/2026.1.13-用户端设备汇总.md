# 用户端设备汇总接口设计文档

## 需求概述

提供用户端设备汇总统计接口，返回当前登录客户的设备总数、在线设备数、离线设备数。

## 接口路径

```
GET /api/cu/devices/summary
```

## 认证要求

- 需要 Bearer Token 认证（C端用户JWT）
- 基于当前登录用户的客户ID进行统计

## 请求参数

无查询参数

## 响应数据结构

### 成功响应

```json
{
  "code": "000000",
  "message": "成功",
  "data": {
    "total_devices": 100,
    "online_devices": 85,
    "offline_devices": 15
  }
}
```

### 响应字段说明

| 字段 | 类型 | 必填 | 描述 |
|------|------|------|------|
| total_devices | int64 | 是 | 设备总数（活跃许可证数） |
| online_devices | int64 | 是 | 在线设备数 |
| offline_devices | int64 | 是 | 离线设备数 |

### 在线状态判断逻辑

参考现有代码实现：
- 通过 `last_heartbeat` 时间戳判断设备是否在线
- 心跳超时时间从配置获取，默认5分钟（300秒）
- 如果 `last_heartbeat + heartbeat_timeout > 当前时间`，则设备在线

### 业务规则

- 统计范围：当前登录用户的客户ID下的所有活跃设备（`status = 'active'` 且 `deleted_at IS NULL`）
- 权限控制：只能查看自己客户ID下的设备数据
- 数据一致性：`total_devices = online_devices + offline_devices`

## 错误响应

| 错误码 | HTTP状态码 | 描述 |
|--------|------------|------|
| 500011 | 401 | 认证令牌无效 |
| 500012 | 401 | 认证令牌已过期 |
| 500010 | 401 | 认证令牌缺失 |
| 900004 | 500 | 服务器内部错误 |

## Swagger 文档

```go
// GetDeviceSummary 获取设备汇总统计
// @Summary 获取设备汇总统计
// @Description 获取当前登录用户的设备汇总统计信息（总数、在线数、离线数）
// @Tags 客户设备管理
// @Accept json
// @Produce json
// @Security BearerAuth
// @Success 200 {object} models.APIResponse{data=models.DeviceSummaryResponse} "获取成功"
// @Failure 401 {object} models.ErrorResponse "未认证"
// @Failure 500 {object} models.ErrorResponse "服务器内部错误"
// @Router /api/cu/devices/summary [get]
```

## 技术实现方案

### 1. 新增响应模型（models/license.go）

```go
// DeviceSummaryResponse 设备汇总响应结构
type DeviceSummaryResponse struct {
    TotalDevices   int64 `json:"total_devices"`   // 设备总数
    OnlineDevices  int64 `json:"online_devices"`  // 在线设备数
    OfflineDevices int64 `json:"offline_devices"` // 离线设备数
}
```

### 2. 服务层接口扩展（service/interfaces.go）

在 `CuDeviceService` 接口中添加：

```go
// 获取设备汇总统计
GetDeviceSummary(ctx context.Context, customerID string) (*models.DeviceSummaryResponse, error)
```

### 3. Repository层接口扩展（repository/interfaces.go）

在 `LicenseRepository` 接口中添加：

```go
// GetCustomerDeviceSummary 获取客户设备汇总统计
GetCustomerDeviceSummary(ctx context.Context, customerID string) (*models.DeviceSummaryResponse, error)
```

### 4. 处理器扩展（handlers/cu_device_handler.go）

添加新的处理器方法：

```go
func (h *CuDeviceHandler) GetDeviceSummary(c *gin.Context) {
    // 从JWT Token中获取用户ID和客户ID
    claims := c.MustGet("cu_user").(*utils.CuClaims)

    // 调用服务层
    result, err := h.cuDeviceService.GetDeviceSummary(c.Request.Context(), claims.CustomerID)
    if err != nil {
        // err已经是i18n.I18nError，直接使用
        i18nErr, ok := err.(*i18n.I18nError)
        if ok {
            c.JSON(i18nErr.HttpCode, models.ErrorResponse{
                Code:      i18nErr.Code,
                Message:   i18nErr.Message,
                Timestamp: getCurrentTimestamp(),
            })
            return
        }
        // 如果不是i18n错误，使用通用错误
        lang := middleware.GetLanguage(c)
        status, errCode, message := i18n.NewI18nErrorResponse("900004", lang, err.Error())
        c.JSON(status, models.ErrorResponse{
            Code:      errCode,
            Message:   message + ": " + err.Error(),
            Timestamp: getCurrentTimestamp(),
        })
        return
    }

    lang := middleware.GetLanguage(c)
    successMessage := i18n.GetI18nErrorMessage("000000", lang)
    c.JSON(http.StatusOK, models.APIResponse{
        Code:    "000000",
        Message: successMessage,
        Data:    result,
    })
}
```

### 5. 路由配置（routes/router.go）

在 cuAuth 路由组中添加：

```go
cuAuth.GET("/devices/summary", cuDeviceHandler.GetDeviceSummary)
```

## 数据库查询逻辑

基于现有 `licenses` 表结构，统计逻辑：

1. **设备总数**：查询 `customer_id = ? AND status = 'active' AND deleted_at IS NULL` 的记录数
2. **在线设备数**：在总数基础上，筛选 `last_heartbeat > (NOW() - INTERVAL heartbeat_timeout SECOND)` 的记录数
3. **离线设备数**：总数减去在线设备数

## 性能优化建议

- 建议对该接口使用缓存，避免频繁的数据库查询
- 可以使用 Redis 缓存，缓存时间建议为 1-5 分钟
- 缓存键设计：`device_summary:{customer_id}`

