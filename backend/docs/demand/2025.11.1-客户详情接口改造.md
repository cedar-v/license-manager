# 客户详情接口改造需求

## 一、接口信息

**接口路径**: `GET /api/customers/{id}`  
**接口说明**: 获取客户详细信息，在原有客户基本信息基础上，新增客户授权统计信息

---

## 二、需求概述

在客户详情接口的响应数据中，新增一个 `authorization_stats` 对象，包含该客户的授权码和许可证相关统计数据，用于在客户详情页面展示客户的授权使用情况。

---

## 三、数据模型设计

### 3.1 响应结构

```json
{
  "code": "000000",
  "message": "success",
  "data": {
    // ... 原有客户基本信息字段 ...
    
    // 新增：授权统计信息
    "authorization_stats": {
      "total_auth_codes": 15,              // 总授权码数量
      "expired_auth_codes": 3,             // 已过期授权码数量
      "expiring_soon_auth_codes": 2,       // 30日内即将到期授权码数量
      "total_licenses": 42,                 // 总许可证数量
      "active_licenses": 28,                // 已激活许可证数量
      "inactive_licenses": 14,              // 未激活许可证数量
      "expired_licenses": 8                 // 已过期许可证数量
    }
  }
}
```

### 3.2 统计字段详细说明

#### 授权码统计（基于 `authorization_codes` 表）

| 字段名 | 类型 | 说明 | 计算规则 |
|--------|------|------|----------|
| `total_auth_codes` | int64 | 总授权码数量 | 统计该客户（`customer_id`）的所有授权码总数 |
| `expired_auth_codes` | int64 | 已过期授权码数量 | `end_date < NOW()` 的授权码数量（不考虑锁定状态） |
| `expiring_soon_auth_codes` | int64 | 30日内即将到期授权码数量 | `end_date >= NOW()` 且 `end_date <= DATE_ADD(NOW(), INTERVAL 30 DAY)` 的授权码数量（不考虑锁定状态） |

#### 许可证统计（基于 `licenses` 表）

| 字段名 | 类型 | 说明 | 计算规则 |
|--------|------|------|----------|
| `total_licenses` | int64 | 总许可证数量 | 统计该客户（`customer_id`）的所有许可证总数 |
| `active_licenses` | int64 | 已激活许可证数量 | `status = 'active'` 的许可证数量 |
| `inactive_licenses` | int64 | 未激活许可证数量 | `total_licenses - active_licenses` |
| `expired_licenses` | int64 | 已过期许可证数量 | 关联的授权码已过期（`authorization_code.end_date < NOW()`）的许可证总数 |

---

## 四、计算逻辑说明

### 4.1 授权码状态判断

- **正常（normal）**: `NOW() >= start_date AND NOW() <= end_date AND is_locked = false`
- **已过期（expired）**: `NOW() > end_date`（无论是否锁定）
- **已锁定（locked）**: `is_locked = true`（锁定状态不影响有效期统计）

**注意**: 
- **过期和即将到期统计不考虑锁定状态**：只要授权码的 `end_date` 满足条件，无论是否锁定都应计入统计
- 例如：即使授权码已锁定，只要 `end_date < NOW()`，仍应计入"已过期授权码数量"

### 4.2 许可证过期判断

许可证的过期状态**依赖于关联的授权码**：
- 许可证本身没有 `end_date` 字段
- 如果许可证关联的授权码已过期（`authorization_codes.end_date < NOW()`），则视为该许可证已过期

### 4.3 边界条件

1. **空数据情况**: 如果客户没有任何授权码或许可证，所有统计值应返回 `0`
2. **软删除**: 只统计未删除的记录（`deleted_at IS NULL`）
3. **时间计算**: 使用服务器当前时间（`NOW()`）作为基准进行判断

---

## 五、相关数据库表

### 5.1 涉及表结构

- **`customers`**: 客户表（主表）
- **`authorization_codes`**: 授权码表
  - `customer_id`: 关联客户ID
  - `start_date`: 授权开始时间
  - `end_date`: 授权结束时间
  - `is_locked`: 是否锁定
- **`licenses`**: 许可证表
  - `customer_id`: 关联客户ID（冗余字段）
  - `authorization_code_id`: 关联授权码ID（外键）
  - `status`: 许可证状态（`active`/`inactive`/`revoked`）

### 5.2 关联关系

```
customers (1) ──< (N) authorization_codes
                    │
                    │ (1)
                    │
                    └──< (N) licenses
```

---

## 六、实现建议

### 6.1 查询优化

建议使用单次 SQL 查询或有限次查询完成统计，避免 N+1 查询问题：

1. **授权码统计**: 使用 `COUNT` + `CASE WHEN` 在一条 SQL 中完成
2. **许可证统计**: 
   - `total_licenses` 和 `active_licenses`: 单次查询统计
   - `expired_licenses`: 需要关联 `authorization_codes` 表判断过期状态

### 6.2 性能考虑

- 确保相关字段已建立索引（如 `customer_id`, `end_date`, `status`, `is_locked`）
- 对于高频访问的接口，可考虑缓存统计结果（需注意数据一致性）

---

## 七、示例数据

假设某客户（ID: `customer-001`）有以下数据：

**授权码数据**:
- 授权码A: `end_date = '2025-12-31'`, `is_locked = false` → 正常
- 授权码B: `end_date = '2025-01-25'`, `is_locked = false` → 30日内即将到期
- 授权码C: `end_date = '2024-12-31'`, `is_locked = false` → 已过期
- 授权码D: `end_date = '2025-12-31'`, `is_locked = true` → 已锁定（正常范围内）
- 授权码E: `end_date = '2024-11-30'`, `is_locked = true` → 已锁定且已过期（仍计入过期统计）
- 授权码F: `end_date = '2025-01-20'`, `is_locked = true` → 已锁定且即将到期（仍计入即将到期统计）

**许可证数据**:
- 授权码A关联: 10个许可证（8个active, 2个inactive）
- 授权码B关联: 5个许可证（4个active, 1个inactive）
- 授权码C关联: 3个许可证（已过期授权码下的所有许可证，均为active）
- 授权码D关联: 2个许可证（1个active, 1个inactive）
- 授权码E关联: 2个许可证（1个active, 1个inactive，因授权码已过期，这2个许可证计入过期许可证）
- 授权码F关联: 1个许可证（1个active）

**统计结果**:
```json
{
  "authorization_stats": {
    "total_auth_codes": 6,
    "expired_auth_codes": 2,          // 授权码C（已过期）+ 授权码E（已锁定但已过期）
    "expiring_soon_auth_codes": 2,    // 授权码B（即将到期）+ 授权码F（已锁定但即将到期）
    "total_licenses": 23,             // 10+5+3+2+2+1 = 23
    "active_licenses": 18,             // 8+4+3+1+1+1 = 18
    "inactive_licenses": 5,            // 23-18 = 5
    "expired_licenses": 5              // 授权码C的3个 + 授权码E的2个 = 5
  }
}
```

---

## 八、验收标准

1. ✅ 接口响应包含 `authorization_stats` 对象
2. ✅ 所有统计字段类型为 `int64`，空数据返回 `0`
3. ✅ 已过期和即将到期授权码统计不考虑锁定状态（仅基于 `end_date` 判断）
4. ✅ 许可证过期判断基于关联授权码的有效期
5. ✅ 计算逻辑准确，边界情况处理正确
6. ✅ 查询性能良好，无明显的性能问题
