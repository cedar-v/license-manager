# 用户订单汇总接口设计文档

## 需求概述

提供用户订单汇总统计接口，返回当前登录客户的订单总数、待支付订单数、已支付订单数。

## 接口路径

```
GET /api/cu/orders/summary
```

## 认证要求

- 需要 Bearer Token 认证（C端用户JWT）
- 基于当前登录用户的客户ID进行统计

## 请求参数

无查询参数

## 响应数据结构

### 成功响应

```json
{
  "code": "000000",
  "message": "成功",
  "data": {
    "total_orders": 100,
    "pending_orders": 15,
    "paid_orders": 85
  }
}
```

### 响应字段说明

| 字段 | 类型 | 必填 | 描述 |
|------|------|------|------|
| total_orders | int64 | 是 | 订单总数 |
| pending_orders | int64 | 是 | 待支付订单数 |
| paid_orders | int64 | 是 | 已支付订单数 |

## 业务规则

- 统计范围：当前登录用户的客户ID下的所有订单（包含已删除订单）
- 订单状态：
  - `pending`: 待支付订单
  - `paid`: 已支付订单
- 数据一致性：`total_orders = pending_orders + paid_orders`

## 错误响应

| 错误码 | HTTP状态码 | 描述 |
|--------|------------|------|
| 500011 | 401 | 认证令牌无效 |
| 500012 | 401 | 认证令牌已过期 |
| 500010 | 401 | 认证令牌缺失 |
| 900004 | 500 | 服务器内部错误 |

## Swagger 文档

```go
// GetOrderSummary 获取订单汇总统计
// @Summary 获取订单汇总统计
// @Description 获取当前登录用户的订单汇总统计信息（总数、待支付数、已支付数）
// @Tags 客户订单管理
// @Accept json
// @Produce json
// @Security BearerAuth
// @Success 200 {object} models.APIResponse{data=models.OrderSummaryResponse} "获取成功"
// @Failure 401 {object} models.ErrorResponse "未认证"
// @Failure 500 {object} models.ErrorResponse "服务器内部错误"
// @Router /api/cu/orders/summary [get]
```

## 技术实现方案

### 1. 新增响应模型（models/cu_order.go）

```go
// OrderSummaryResponse 订单汇总响应结构
type OrderSummaryResponse struct {
    TotalOrders   int64 `json:"total_orders"`    // 订单总数
    PendingOrders int64 `json:"pending_orders"`  // 待支付订单数
    PaidOrders    int64 `json:"paid_orders"`     // 已支付订单数
}
```

### 2. 服务层接口扩展（service/interfaces.go）

在 `CuOrderService` 接口中添加：

```go
// 获取订单汇总统计
GetOrderSummary(ctx context.Context, customerID string) (*models.OrderSummaryResponse, error)
```

### 3. Repository层接口扩展（repository/interfaces.go）

在 `CuOrderRepository` 接口中添加：

```go
// GetCustomerOrderSummary 获取客户订单汇总统计
GetCustomerOrderSummary(ctx context.Context, customerID string) (*models.OrderSummaryResponse, error)
```

### 4. 处理器扩展（handlers/cu_order_handler.go）

添加新的处理器方法：

```go
func (h *CuOrderHandler) GetOrderSummary(c *gin.Context) {
    // 从JWT Token中获取用户ID和客户ID
    claims := c.MustGet("cu_user").(*utils.CuClaims)

    // 调用服务层
    result, err := h.cuOrderService.GetOrderSummary(c.Request.Context(), claims.CustomerID)
    if err != nil {
        // err已经是i18n.I18nError，直接使用
        i18nErr, ok := err.(*i18n.I18nError)
        if ok {
            c.JSON(i18nErr.HttpCode, models.ErrorResponse{
                Code:      i18nErr.Code,
                Message:   i18nErr.Message,
                Timestamp: getCurrentTimestamp(),
            })
            return
        }
        // 如果不是i18n错误，使用通用错误
        lang := middleware.GetLanguage(c)
        status, errCode, message := i18n.NewI18nErrorResponse("900004", lang, err.Error())
        c.JSON(status, models.ErrorResponse{
            Code:      errCode,
            Message:   message + ": " + err.Error(),
            Timestamp: getCurrentTimestamp(),
        })
        return
    }

    lang := middleware.GetLanguage(c)
    successMessage := i18n.GetI18nErrorMessage("000000", lang)
    c.JSON(http.StatusOK, models.APIResponse{
        Code:    "000000",
        Message: successMessage,
        Data:    result,
    })
}
```

### 5. 路由配置（routes/router.go）

在 cuAuth 路由组中添加：

```go
cuAuth.GET("/orders/summary", cuOrderHandler.GetOrderSummary)
```

## 数据库查询逻辑

基于现有 `cu_orders` 表结构，统计逻辑：

1. **订单总数**：查询 `customer_id = ?` 的记录数（包含所有状态）
2. **待支付订单数**：查询 `customer_id = ? AND status = 'pending'` 的记录数
3. **已支付订单数**：查询 `customer_id = ? AND status = 'paid'` 的记录数